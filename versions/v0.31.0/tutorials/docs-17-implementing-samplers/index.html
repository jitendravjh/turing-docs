<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Implementing samplers – Turing.jl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../versions.html" rel="next">
<link href="../../tutorials/docs-07-for-developers-variational-inference/index.html" rel="prev">
<link href="../../assets/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<style>
  a {
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../theming/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://turinglang.org/" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/turing-logo.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="https://turinglang.org/">
    <span class="navbar-title">Turing.jl</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/docs-00-getting-started/"> 
<span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/00-introduction/"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/library/"> 
<span class="menu-text">Library API</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/news/"> 
<span class="menu-text">News</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/team/"> 
<span class="menu-text">Team</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://x.com/TuringLang" title="Turing Twitter" class="quarto-navigation-tool px-1" aria-label="Turing Twitter"><i class="bi bi-twitter"></i></a>
    <a href="https://github.com/TuringLang/Turing.jl" title="Turing GitHub" class="quarto-navigation-tool px-1" aria-label="Turing GitHub"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Documentation</li><li class="breadcrumb-item"><a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html">For Developers (Inference)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-17-implementing-samplers/index.html">Implementing Samplers</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Using Turing - Modelling Syntax and Interface</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-00-getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-14-using-turing-quick-start/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick Start</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-12-using-turing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-17-mode-estimation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mode Estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-09-using-turing-advanced/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Usage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-10-using-turing-autodiff/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-13-using-turing-performance-tips/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Performance Tips</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-11-using-turing-dynamichmc/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using DynamicHMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-15-using-turing-sampler-viz/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampler Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-16-using-turing-external-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">External Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Using Turing - Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/00-introduction/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Turing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/01-gaussian-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/02-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/03-bayesian-neural-network/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/04-hidden-markov-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hidden Markov Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/05-linear-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/06-infinite-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Infinite Mixture Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/07-poisson-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Poisson Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/08-multinomial-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multinomial Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/09-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/10-bayesian-differential-equations/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Differential Equations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/11-probabilistic-pca/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic PCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/13-seasonal-time-series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Time Series Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/15-gaussian-processes/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Gaussian Processes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/12-gplvm/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Process Latent Variable Models</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">For Developers (PPL)</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-01-contributing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to Contribute</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-05-for-developers-compiler/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Turing Compiler Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/14-minituring/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation I: Compiler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/16-contexts/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation II: Contexts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-06-for-developers-interface/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interface Guide</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">For Developers (Inference)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How Turing implements AbstractMCMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-07-for-developers-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-17-implementing-samplers/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Implementing Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../versions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Versions</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#quick-overview-of-mala" id="toc-quick-overview-of-mala" class="nav-link active" data-scroll-target="#quick-overview-of-mala">Quick overview of MALA</a></li>
  <li><a href="#what-we-need-from-a-model-logdensityproblems.jl" id="toc-what-we-need-from-a-model-logdensityproblems.jl" class="nav-link" data-scroll-target="#what-we-need-from-a-model-logdensityproblems.jl">What we need from a model: LogDensityProblems.jl</a></li>
  <li><a href="#implementing-mala-in-abstractmcmc.jl" id="toc-implementing-mala-in-abstractmcmc.jl" class="nav-link" data-scroll-target="#implementing-mala-in-abstractmcmc.jl">Implementing MALA in AbstractMCMC.jl</a></li>
  <li><a href="#using-our-sampler-with-turing.jl" id="toc-using-our-sampler-with-turing.jl" class="nav-link" data-scroll-target="#using-our-sampler-with-turing.jl">Using our sampler with Turing.jl</a>
  <ul class="collapse">
  <li><a href="#models-with-constrained-parameters" id="toc-models-with-constrained-parameters" class="nav-link" data-scroll-target="#models-with-constrained-parameters">Models with constrained parameters</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-17-implementing-samplers/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Documentation</li><li class="breadcrumb-item"><a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html">For Developers (Inference)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-17-implementing-samplers/index.html">Implementing Samplers</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Implementing samplers</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this tutorial, we’ll go through step-by-step how to implement a “simple” sampler in <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> in such a way that it can be easily applied to Turing.jl models.</p>
<p>In particular, we’re going to implement a version of <strong>Metropolis-adjusted Langevin (MALA)</strong>.</p>
<p>Note that we will implement this sampler in the <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> framework, completely “ignoring” Turing.jl until the very end of the tutorial, at which point we’ll use a single line of code to make the resulting sampler available to Turing.jl. This is to really drive home the point that one can implement samplers in a way that is accessible to all of Turing.jl’s users without having to use Turing.jl yourself.</p>
<section id="quick-overview-of-mala" class="level2">
<h2 class="anchored" data-anchor-id="quick-overview-of-mala">Quick overview of MALA</h2>
<p>We can view MALA as a single step of the leapfrog intergrator with resampling of momentum <span class="math inline">\(p\)</span> at every step.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> To make that statement a bit more concrete, we first define the <em>extended</em> target <span class="math inline">\(\bar{\gamma}(x, p)\)</span> as</p>
<p><span class="math display">\[\begin{equation*}
\log \bar{\gamma}(x, p) \propto \log \gamma(x) + \log \gamma_{\mathcal{N}(0, M)}(p)
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(\gamma_{\mathcal{N}(0, M)}\)</span> denotes the density for a zero-centered Gaussian with covariance matrix <span class="math inline">\(M\)</span>. We then consider targeting this joint distribution over both <span class="math inline">\(x\)</span> and <span class="math inline">\(p\)</span> as follows. First we define the map</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  L_{\epsilon}: \quad &amp; \mathbb{R}^d \times \mathbb{R}^d \to \mathbb{R}^d \times \mathbb{R}^d \\
  &amp; (x, p) \mapsto (\tilde{x}, \tilde{p}) := L_{\epsilon}(x, p)
\end{split}
\end{equation*}\]</span></p>
<p>as</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  p_{1 / 2} &amp;:= p + \frac{\epsilon}{2} \nabla \log \gamma(x) \\
  \tilde{x} &amp;:= x + \epsilon M^{-1} p_{1 /2 } \\
  p_1 &amp;:= p_{1 / 2} + \frac{\epsilon}{2} \nabla \log \gamma(\tilde{x}) \\
  \tilde{p} &amp;:= - p_1
\end{split}
\end{equation*}\]</span></p>
<p>This might be familiar for some readers as a single step of the Leapfrog integrator. We then define the MALA kernel as follows: given the current iterate <span class="math inline">\(x_i\)</span>, we sample the next iterate <span class="math inline">\(x_{i + 1}\)</span> as</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  p &amp;\sim \mathcal{N}(0, M) \\
  (\tilde{x}, \tilde{p}) &amp;:= L_{\epsilon}(x_i, p) \\
  \alpha &amp;:= \min \left\{ 1, \frac{\bar{\gamma}(\tilde{x}, \tilde{p})}{\bar{\gamma}(x_i, p)} \right\} \\
  x_{i + 1} &amp;:=
  \begin{cases}
    \tilde{x} \quad &amp; \text{ with prob. } \alpha \\
    x_i       \quad &amp; \text{ with prob. } 1 - \alpha
  \end{cases}
\end{split}
\end{equation*}\]</span></p>
<p>i.e.&nbsp;we accept the proposal <span class="math inline">\(\tilde{x}\)</span> with probability <span class="math inline">\(\alpha\)</span> and reject it, thus sticking with our current iterate, with probability <span class="math inline">\(1 - \alpha\)</span>.</p>
</section>
<section id="what-we-need-from-a-model-logdensityproblems.jl" class="level2">
<h2 class="anchored" data-anchor-id="what-we-need-from-a-model-logdensityproblems.jl">What we need from a model: <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a></h2>
<p>There are a few things we need from the “target” / “model” / density that we want to sample from:</p>
<ol type="1">
<li>We need access to log-density <em>evaluations</em> <span class="math inline">\(\log \gamma(x)\)</span> so we can compute the acceptance ratio involving <span class="math inline">\(\log \bar{\gamma}(x, p)\)</span>.</li>
<li>We need access to log-density <em>gradients</em> <span class="math inline">\(\nabla \log \gamma(x)\)</span> so we can compute the Leapfrog steps <span class="math inline">\(L_{\epsilon}(x, p)\)</span>.</li>
<li>We also need access to the “size” of the model so we can determine the size of <span class="math inline">\(M\)</span>.</li>
</ol>
<p>Luckily for us, there is a package called <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> which provides an interface for <em>exactly</em> this!</p>
<p>To demonstrate how one can implement the “<a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface”<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> we will use a simple Gaussian model as an example:</p>
<div id="4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LogDensityProblems</span>: LogDensityProblems;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's define some type that represents the model.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> IsotropicNormalModel{M<span class="op">&lt;:</span><span class="dt">AbstractVector{&lt;:Real}</span>}</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean of the isotropic Gaussian"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    mean<span class="op">::</span><span class="dt">M</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Specifies what input length the model expects.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">dimension</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> <span class="fu">length</span>(model.mean)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Implementation of the log-density evaluation of the model.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> LogDensityProblems.<span class="fu">logdensity</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>, x<span class="op">::</span><span class="dt">AbstractVector{&lt;:Real}</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span> <span class="fu">sum</span>(abs2, x <span class="op">.-</span> model.mean) <span class="op">/</span> <span class="fl">2</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us all of the properties we want for our MALA sampler with the exception of the computation of the <em>gradient</em> <span class="math inline">\(\nabla \log \gamma(x)\)</span>. There is the method <code>LogDensityProblems.logdensity_and_gradient</code> which should return a 2-tuple where the first entry is the evaluation of the logdensity <span class="math inline">\(\log \gamma(x)\)</span> and the second entry is the gradient <span class="math inline">\(\nabla \log \gamma(x)\)</span>.</p>
<p>There are two ways to “implement” this method: 1) we implement it by hand, which is feasible in the case of our <code>IsotropicNormalModel</code>, or b) we defer the implementation of this to a automatic differentiation backend.</p>
<p>To implement it by hand we can simply do</p>
<div id="6" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell LogDensityProblems.jl that first-order, i.e. gradient information, is available.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">capabilities</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> LogDensityProblems.<span class="fu">LogDensityOrder</span><span class="dt">{1}</span>()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement `logdensity_and_gradient`.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>, x)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    logγ_x <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x <span class="op">=</span> <span class="op">-</span>x <span class="op">.*</span> (x <span class="op">-</span> model.mean)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> logγ_x, ∇logγ_x</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s just try it out:</p>
<div id="8" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate the problem.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">IsotropicNormalModel</span>([<span class="op">-</span><span class="fl">5</span>., <span class="fl">0</span>., <span class="fl">5</span>.])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create some example input that we can test on.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>x_example <span class="op">=</span> <span class="fu">randn</span>(LogDensityProblems.<span class="fu">dimension</span>(model))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate!</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">logdensity</span>(model, x_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-37.07804237026973</code></pre>
</div>
</div>
<p>To defer it to an automatic differentiation backend, we can do</p>
<div id="10" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell LogDensityProblems.jl we only have access to 0-th order information.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">capabilities</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> LogDensityProblems.<span class="fu">LogDensityOrder</span><span class="dt">{0}</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `LogDensityProblemsAD`'s `ADgradient` in combination with some AD backend to implement `logdensity_and_gradient`.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LogDensityProblemsAD</span>, <span class="bu">ADTypes</span>, <span class="bu">ForwardDiff</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>model_with_grad <span class="op">=</span> <span class="fu">ADgradient</span>(<span class="fu">AutoForwardDiff</span>(), model)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">logdensity</span>(model_with_grad, x_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-37.07804237026973</code></pre>
</div>
</div>
<p>We’ll continue with the second approach in this tutorial since this is typically what one does in practice, because there are better hobbies to spend time on than deriving gradients by hand.</p>
<p>At this point, one might wonder how we’re going to tie this back to Turing.jl in the end. Effectively, when working with inference methods that only require log-density evaluations and / or higher-order information of the log-density, Turing.jl actually converts the user-provided <code>Model</code> into an object implementing the above methods for <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>. As a result, most samplers provided by Turing.jl are actually implemented to work with <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>, enabling their use both <em>within</em> Turing.jl and <em>outside</em> of Turing.jl! Morever, there exists similar conversions for Stan through BridgeStan and Stan<a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>, which means that a sampler supporting the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface can easily be used on both Turing.jl <em>and</em> Stan models (in addition to user-provided models, as our <code>IsotropicNormalModel</code> above)!</p>
<p>Anyways, let’s move on to actually implementing the sampler.</p>
</section>
<section id="implementing-mala-in-abstractmcmc.jl" class="level2">
<h2 class="anchored" data-anchor-id="implementing-mala-in-abstractmcmc.jl">Implementing MALA in <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a></h2>
<p>Now that we’ve established that a model implementing the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface provides us with all the information we need from <span class="math inline">\(\log \gamma(x)\)</span>, we can address the question: given an object that implements the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface, how can we define a sampler for it?</p>
<p>We’re going to do this by making our sampler a sub-type of <code>AbstractMCMC.AbstractSampler</code> in addition to implementing a few methods from <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a>. Why? Because it gets us <em>a lot</em> of functionality for free, as we will see later.</p>
<p>Moreover, <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> provides a very natural interface for MCMC algorithms.</p>
<p>First, we’ll define our <code>MALA</code> type</p>
<div id="12" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">AbstractMCMC</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MALA{T,A} <span class="op">&lt;:</span><span class="dt"> AbstractMCMC.AbstractSampler</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stepsize used in the leapfrog step"</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    ϵ_init<span class="op">::</span><span class="dt">T</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariance matrix used for the momentum"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    M_init<span class="op">::</span><span class="dt">A</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how we’ve added the suffix <code>_init</code> to both the stepsize and the covariance matrix. We’ve done this because a <code>AbstractMCMC.AbstractSampler</code> should be <em>immutable</em>. Of course there might be many scenarios where we want to allow something like the stepsize and / or the covariance matrix to vary between iterations, e.g.&nbsp;during the burn-in / adaptation phase of the sampling process we might want to adjust the parameters using statistics computed from these initial iterations. But information which can change between iterations <em>should not go in the sampler itself</em>! Instead, this information should go in the sampler <em>state</em>.</p>
<p>The sampler state should at the very least contain all the necessary information to perform the next MCMC iteration, but usually contains further information, e.g.&nbsp;quantities and statistics useful for evaluating whether the sampler has converged.</p>
<p>We will use the following sampler state for our <code>MALA</code> sampler:</p>
<div id="14" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MALAState{A<span class="op">&lt;:</span><span class="dt">AbstractVector{&lt;:Real}</span>}</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"current position"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">::</span><span class="dt">A</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This might seem overly redundant: we’re defining a type <code>MALAState</code> and it only contains a simple vector of reals. In this particular case we indeed could have dropped this and simply used a <code>AbstractVector{&lt;:Real}</code> as our sampler state, but typically, as we will see later, one wants to include other quantities in the sampler state. For example, if we also wanted to adapt the parameters of our <code>MALA</code>, e.g.&nbsp;alter the stepsize depending on acceptance rates, in which case we should also put <code>ϵ</code> in the state, but for now we’ll keep things simple.</p>
<p>Moreover, we also want a <em>sample</em> type, which is a type meant for “public consumption”, i.e.&nbsp;the end-user. This is generally going to contain a subset of the information present in the state. But in such a simple scenario as this, we similarly only have a <code>AbstractVector{&lt;:Real}</code>:</p>
<div id="16" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MALASample{A<span class="op">&lt;:</span><span class="dt">AbstractVector{&lt;:Real}</span>}</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"current position"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">::</span><span class="dt">A</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We currently have three things:</p>
<ol type="1">
<li>A <code>AbstractMCMC.AbstractSampler</code> implementation called <code>MALA</code>.</li>
<li>A state <code>MALAState</code> for our sampler <code>MALA</code>.</li>
<li>A sample <code>MALASample</code> for our sampler <code>MALA</code>.</li>
</ol>
<p>That means that we’re ready to implement the only thing that really matters: <code>AbstractMCMC.step</code>.</p>
<p><code>AbstractMCMC.step</code> defines the MCMC iteration of our <code>MALA</code> given the current <code>MALAState</code>. Specifically, the signature of the function is as follows:</p>
<div id="18" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The RNG to ensure reproducibility.</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The model that defines our target.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">::</span><span class="dt">AbstractMCMC.AbstractModel</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The sampler for which we're taking a `step`.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">AbstractMCMC.AbstractSampler</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The current sampler `state`.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    state;</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional keyword arguments that we may or may not need.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moreover, there is a specific <code>AbstractMCMC.AbstractModel</code> which is used to indicate that the model that is provided implements the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface: <code>AbstractMCMC.LogDensityModel</code>.</p>
<p>Since, as we discussed earlier, in our case we’re indeed going to work with types that support the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface, we’ll define <code>AbstractMCMC.step</code> for such a <code>AbstractMCMC.LogDensityModel</code>.</p>
<p>Note that <code>AbstractMCMC.LogDensityModel</code> has no other purpose; it has a single field called <code>logdensity</code>, and it does nothing else. But by wrapping the model in <code>AbstractMCMC.LogDensityModel</code>, it allows samplers that want to work with <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> to define their <code>AbstractMCMC.step</code> on this type without running into method ambiguities.</p>
<p>All in all, that means that the signature for our <code>AbstractMCMC.step</code> is going to be the following:</p>
<div id="20" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `LogDensityModel` so we know we're working with LogDensityProblems.jl model.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    model<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Our sampler.</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">MALA</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Our sampler state.</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    state<span class="op">::</span><span class="dt">MALAState</span>;</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great! Now let’s actually implement the full <code>AbstractMCMC.step</code> for our <code>MALA</code>.</p>
<p>Let’s remind ourselves what we’re going to do:</p>
<ol type="1">
<li>Sample a new momentum <span class="math inline">\(p\)</span>.</li>
<li>Compute the log-density of the extended target <span class="math inline">\(\log \bar{\gamma}(x, p)\)</span>.</li>
<li>Take a single leapfrog step <span class="math inline">\((\tilde{x}, \tilde{p}) = L_{\epsilon}(x, p)\)</span>.</li>
<li>Accept or reject the proposed <span class="math inline">\((\tilde{x}, \tilde{p})\)</span>.</li>
</ol>
<p>All in all, this results in the following:</p>
<div id="22" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>: Random</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span>  <span class="co"># so we get the `MvNormal`</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    model_wrapper<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">MALA</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    state<span class="op">::</span><span class="dt">MALAState</span>;</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the wrapped model which implements LogDensityProblems.jl.</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_wrapper.logdensity</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's just extract the sampler parameters to make our lives easier.</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    ϵ <span class="op">=</span> sampler.ϵ_init</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sampler.M_init</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the current parameters.</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> state.x</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample the momentum.</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    p_dist <span class="op">=</span> <span class="fu">MvNormal</span>(<span class="fu">zeros</span>(LogDensityProblems.<span class="fu">dimension</span>(model)), M)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">rand</span>(rng, p_dist)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propose using a single leapfrog step.</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    x̃, p̃ <span class="op">=</span> <span class="fu">leapfrog_step</span>(model, x, p, ϵ, M)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accept or reject proposal.</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    logp <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x) <span class="op">+</span> <span class="fu">logpdf</span>(p_dist, p)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    logp̃ <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x̃) <span class="op">+</span> <span class="fu">logpdf</span>(p_dist, p̃)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    logα <span class="op">=</span> logp̃ <span class="op">-</span> logp</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    state_new <span class="op">=</span> <span class="cf">if</span> <span class="fu">log</span>(<span class="fu">rand</span>(rng)) <span class="op">&lt;</span> logα</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Accept.</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">MALAState</span>(x̃)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reject.</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">MALAState</span>(x)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the "sample" and the sampler state.</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">MALASample</span>(state_new.x), state_new</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fairly straight-forward.</p>
<p>Of course, we haven’t defined the <code>leapfrog_step</code> method yet, so let’s do that:</p>
<div id="24" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">leapfrog_step</span>(model, x, p, ϵ, M)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update momentum `p` using "position" `x`.</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x <span class="op">=</span> <span class="fu">last</span>(LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model, x))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    p1 <span class="op">=</span> p <span class="op">+</span> (ϵ <span class="op">/</span> <span class="fl">2</span>) <span class="op">.*</span> ∇logγ_x</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the "position" `x` using momentum `p1`.</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    x̃ <span class="op">=</span> x <span class="op">+</span> ϵ <span class="op">.*</span> (M <span class="op">\</span> p1)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update momentum `p1` using position `x̃`</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x̃ <span class="op">=</span> <span class="fu">last</span>(LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model, x̃))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    p2 <span class="op">=</span> p1 <span class="op">+</span> (ϵ <span class="op">/</span> <span class="fl">2</span>) <span class="op">.*</span> ∇logγ_x̃</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flip momentum `p2`.</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    p̃ <span class="op">=</span> <span class="op">-</span>p2</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x̃, p̃</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>leapfrog_step (generic function with 1 method)</code></pre>
</div>
</div>
<p>With all of this, we’re technically ready to sample!</p>
<div id="26" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>, <span class="bu">LinearAlgebra</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_rng</span>()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>sampler <span class="op">=</span> <span class="fu">MALA</span>(<span class="fl">1</span>, I)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> <span class="fu">MALAState</span>(<span class="fu">zeros</span>(LogDensityProblems.<span class="fu">dimension</span>(model)))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>x_next, state_next <span class="op">=</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    rng,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    AbstractMCMC.<span class="fu">LogDensityModel</span>(model),</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    sampler,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    state</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(MALASample{Vector{Float64}}([0.0, 0.0, 0.0]), MALAState{Vector{Float64}}([0.0, 0.0, 0.0]))</code></pre>
</div>
</div>
<p>Great, it works!</p>
<p>And I promised we would get quite some functionality for free if we implemented <code>AbstractMCMC.step</code>, and so we can now simply call <code>sample</code> to perform standard MCMC sampling:</p>
<div id="28" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform 1000 iterations with our `MALA` sampler.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(model_with_grad, sampler, <span class="fl">10_000</span>; initial_state<span class="op">=</span>state, progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate into a matrix.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>samples_matrix <span class="op">=</span> <span class="fu">stack</span>(sample <span class="op">-&gt;</span> sample.x, samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×10000 Matrix{Float64}:
 -3.26132   -3.31365  -4.22208   -3.22018   …  -5.57323  -5.77153   -5.33458
 -0.826486  -1.15887  -0.418583   0.986428      1.08551  -0.969172   0.309181
  3.55368    5.16403   5.79635    3.78192       4.20583   4.60781    5.6645</code></pre>
</div>
</div>
<div id="30" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the marginal means and standard deviations.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hcat</span>(<span class="fu">mean</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>), <span class="fu">std</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×2 Matrix{Float64}:
 -4.98821     1.0092
 -0.00215206  0.98508
  5.01204     0.995733</code></pre>
</div>
</div>
<p>Let’s visualize the samples</p>
<div id="32" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StatsPlots</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">transpose</span>(samples_matrix[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">:</span><span class="kw">end</span>]), alpha<span class="op">=</span><span class="fl">0.5</span>, legend<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="672" height="480" viewbox="0 0 2688 1920">
<defs>
  <clippath id="clip170">
    <rect x="0" y="0" width="2688" height="1920"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip170)" d="M0 1920 L2688 1920 L2688 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip171">
    <rect x="537" y="0" width="1883" height="1883"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip170)" d="M151.747 1800.78 L2640.76 1800.78 L2640.76 47.2441 L151.747 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip172">
    <rect x="151" y="47" width="2490" height="1755"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="219.84,1800.78 219.84,47.2441 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="807.458,1800.78 807.458,47.2441 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1395.08,1800.78 1395.08,47.2441 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1982.69,1800.78 1982.69,47.2441 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2570.31,1800.78 2570.31,47.2441 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1800.78 2640.76,1800.78 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="219.84,1800.78 219.84,1781.88 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="807.458,1800.78 807.458,1781.88 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1395.08,1800.78 1395.08,1781.88 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1982.69,1800.78 1982.69,1781.88 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2570.31,1800.78 2570.31,1781.88 "></polyline>
<path clip-path="url(#clip170)" d="M219.84 1834 Q216.229 1834 214.4 1837.57 Q212.595 1841.11 212.595 1848.24 Q212.595 1855.34 214.4 1858.91 Q216.229 1862.45 219.84 1862.45 Q223.474 1862.45 225.28 1858.91 Q227.108 1855.34 227.108 1848.24 Q227.108 1841.11 225.28 1837.57 Q223.474 1834 219.84 1834 M219.84 1830.3 Q225.65 1830.3 228.706 1834.9 Q231.784 1839.49 231.784 1848.24 Q231.784 1856.96 228.706 1861.57 Q225.65 1866.15 219.84 1866.15 Q214.03 1866.15 210.951 1861.57 Q207.896 1856.96 207.896 1848.24 Q207.896 1839.49 210.951 1834.9 Q214.03 1830.3 219.84 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M771.15 1861.55 L787.47 1861.55 L787.47 1865.48 L765.525 1865.48 L765.525 1861.55 Q768.187 1858.79 772.771 1854.16 Q777.377 1849.51 778.558 1848.17 Q780.803 1845.65 781.683 1843.91 Q782.585 1842.15 782.585 1840.46 Q782.585 1837.71 780.641 1835.97 Q778.72 1834.23 775.618 1834.23 Q773.419 1834.23 770.965 1835 Q768.535 1835.76 765.757 1837.31 L765.757 1832.59 Q768.581 1831.46 771.035 1830.88 Q773.488 1830.3 775.525 1830.3 Q780.896 1830.3 784.09 1832.98 Q787.285 1835.67 787.285 1840.16 Q787.285 1842.29 786.474 1844.21 Q785.687 1846.11 783.581 1848.7 Q783.002 1849.37 779.9 1852.59 Q776.798 1855.78 771.15 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M797.331 1830.92 L815.687 1830.92 L815.687 1834.86 L801.613 1834.86 L801.613 1843.33 Q802.632 1842.98 803.65 1842.82 Q804.669 1842.64 805.687 1842.64 Q811.474 1842.64 814.854 1845.81 Q818.233 1848.98 818.233 1854.4 Q818.233 1859.97 814.761 1863.08 Q811.289 1866.15 804.97 1866.15 Q802.794 1866.15 800.525 1865.78 Q798.28 1865.41 795.872 1864.67 L795.872 1859.97 Q797.956 1861.11 800.178 1861.66 Q802.4 1862.22 804.877 1862.22 Q808.882 1862.22 811.22 1860.11 Q813.558 1858.01 813.558 1854.4 Q813.558 1850.78 811.22 1848.68 Q808.882 1846.57 804.877 1846.57 Q803.002 1846.57 801.127 1846.99 Q799.275 1847.4 797.331 1848.28 L797.331 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M837.446 1834 Q833.835 1834 832.007 1837.57 Q830.201 1841.11 830.201 1848.24 Q830.201 1855.34 832.007 1858.91 Q833.835 1862.45 837.446 1862.45 Q841.081 1862.45 842.886 1858.91 Q844.715 1855.34 844.715 1848.24 Q844.715 1841.11 842.886 1837.57 Q841.081 1834 837.446 1834 M837.446 1830.3 Q843.256 1830.3 846.312 1834.9 Q849.391 1839.49 849.391 1848.24 Q849.391 1856.96 846.312 1861.57 Q843.256 1866.15 837.446 1866.15 Q831.636 1866.15 828.557 1861.57 Q825.502 1856.96 825.502 1848.24 Q825.502 1839.49 828.557 1834.9 Q831.636 1830.3 837.446 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M1354.69 1830.92 L1373.05 1830.92 L1373.05 1834.86 L1358.98 1834.86 L1358.98 1843.33 Q1360 1842.98 1361.01 1842.82 Q1362.03 1842.64 1363.05 1842.64 Q1368.84 1842.64 1372.22 1845.81 Q1375.6 1848.98 1375.6 1854.4 Q1375.6 1859.97 1372.12 1863.08 Q1368.65 1866.15 1362.33 1866.15 Q1360.16 1866.15 1357.89 1865.78 Q1355.64 1865.41 1353.24 1864.67 L1353.24 1859.97 Q1355.32 1861.11 1357.54 1861.66 Q1359.76 1862.22 1362.24 1862.22 Q1366.25 1862.22 1368.58 1860.11 Q1370.92 1858.01 1370.92 1854.4 Q1370.92 1850.78 1368.58 1848.68 Q1366.25 1846.57 1362.24 1846.57 Q1360.37 1846.57 1358.49 1846.99 Q1356.64 1847.4 1354.69 1848.28 L1354.69 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M1394.81 1834 Q1391.2 1834 1389.37 1837.57 Q1387.56 1841.11 1387.56 1848.24 Q1387.56 1855.34 1389.37 1858.91 Q1391.2 1862.45 1394.81 1862.45 Q1398.44 1862.45 1400.25 1858.91 Q1402.08 1855.34 1402.08 1848.24 Q1402.08 1841.11 1400.25 1837.57 Q1398.44 1834 1394.81 1834 M1394.81 1830.3 Q1400.62 1830.3 1403.68 1834.9 Q1406.75 1839.49 1406.75 1848.24 Q1406.75 1856.96 1403.68 1861.57 Q1400.62 1866.15 1394.81 1866.15 Q1389 1866.15 1385.92 1861.57 Q1382.87 1856.96 1382.87 1848.24 Q1382.87 1839.49 1385.92 1834.9 Q1389 1830.3 1394.81 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M1424.97 1834 Q1421.36 1834 1419.53 1837.57 Q1417.73 1841.11 1417.73 1848.24 Q1417.73 1855.34 1419.53 1858.91 Q1421.36 1862.45 1424.97 1862.45 Q1428.61 1862.45 1430.41 1858.91 Q1432.24 1855.34 1432.24 1848.24 Q1432.24 1841.11 1430.41 1837.57 Q1428.61 1834 1424.97 1834 M1424.97 1830.3 Q1430.78 1830.3 1433.84 1834.9 Q1436.92 1839.49 1436.92 1848.24 Q1436.92 1856.96 1433.84 1861.57 Q1430.78 1866.15 1424.97 1866.15 Q1419.16 1866.15 1416.08 1861.57 Q1413.03 1856.96 1413.03 1848.24 Q1413.03 1839.49 1416.08 1834.9 Q1419.16 1830.3 1424.97 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M1940.97 1830.92 L1963.19 1830.92 L1963.19 1832.91 L1950.65 1865.48 L1945.76 1865.48 L1957.57 1834.86 L1940.97 1834.86 L1940.97 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M1972.36 1830.92 L1990.71 1830.92 L1990.71 1834.86 L1976.64 1834.86 L1976.64 1843.33 Q1977.66 1842.98 1978.68 1842.82 Q1979.7 1842.64 1980.72 1842.64 Q1986.5 1842.64 1989.88 1845.81 Q1993.26 1848.98 1993.26 1854.4 Q1993.26 1859.97 1989.79 1863.08 Q1986.32 1866.15 1980 1866.15 Q1977.82 1866.15 1975.55 1865.78 Q1973.31 1865.41 1970.9 1864.67 L1970.9 1859.97 Q1972.98 1861.11 1975.21 1861.66 Q1977.43 1862.22 1979.9 1862.22 Q1983.91 1862.22 1986.25 1860.11 Q1988.59 1858.01 1988.59 1854.4 Q1988.59 1850.78 1986.25 1848.68 Q1983.91 1846.57 1979.9 1846.57 Q1978.03 1846.57 1976.15 1846.99 Q1974.3 1847.4 1972.36 1848.28 L1972.36 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M2012.47 1834 Q2008.86 1834 2007.03 1837.57 Q2005.23 1841.11 2005.23 1848.24 Q2005.23 1855.34 2007.03 1858.91 Q2008.86 1862.45 2012.47 1862.45 Q2016.11 1862.45 2017.91 1858.91 Q2019.74 1855.34 2019.74 1848.24 Q2019.74 1841.11 2017.91 1837.57 Q2016.11 1834 2012.47 1834 M2012.47 1830.3 Q2018.28 1830.3 2021.34 1834.9 Q2024.42 1839.49 2024.42 1848.24 Q2024.42 1856.96 2021.34 1861.57 Q2018.28 1866.15 2012.47 1866.15 Q2006.66 1866.15 2003.59 1861.57 Q2000.53 1856.96 2000.53 1848.24 Q2000.53 1839.49 2003.59 1834.9 Q2006.66 1830.3 2012.47 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M2514.84 1861.55 L2522.48 1861.55 L2522.48 1835.18 L2514.17 1836.85 L2514.17 1832.59 L2522.43 1830.92 L2527.11 1830.92 L2527.11 1861.55 L2534.75 1861.55 L2534.75 1865.48 L2514.84 1865.48 L2514.84 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M2554.19 1834 Q2550.58 1834 2548.75 1837.57 Q2546.94 1841.11 2546.94 1848.24 Q2546.94 1855.34 2548.75 1858.91 Q2550.58 1862.45 2554.19 1862.45 Q2557.82 1862.45 2559.63 1858.91 Q2561.46 1855.34 2561.46 1848.24 Q2561.46 1841.11 2559.63 1837.57 Q2557.82 1834 2554.19 1834 M2554.19 1830.3 Q2560 1830.3 2563.06 1834.9 Q2566.13 1839.49 2566.13 1848.24 Q2566.13 1856.96 2563.06 1861.57 Q2560 1866.15 2554.19 1866.15 Q2548.38 1866.15 2545.3 1861.57 Q2542.25 1856.96 2542.25 1848.24 Q2542.25 1839.49 2545.3 1834.9 Q2548.38 1830.3 2554.19 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M2584.35 1834 Q2580.74 1834 2578.91 1837.57 Q2577.11 1841.11 2577.11 1848.24 Q2577.11 1855.34 2578.91 1858.91 Q2580.74 1862.45 2584.35 1862.45 Q2587.99 1862.45 2589.79 1858.91 Q2591.62 1855.34 2591.62 1848.24 Q2591.62 1841.11 2589.79 1837.57 Q2587.99 1834 2584.35 1834 M2584.35 1830.3 Q2590.16 1830.3 2593.22 1834.9 Q2596.3 1839.49 2596.3 1848.24 Q2596.3 1856.96 2593.22 1861.57 Q2590.16 1866.15 2584.35 1866.15 Q2578.54 1866.15 2575.46 1861.57 Q2572.41 1856.96 2572.41 1848.24 Q2572.41 1839.49 2575.46 1834.9 Q2578.54 1830.3 2584.35 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M2614.51 1834 Q2610.9 1834 2609.07 1837.57 Q2607.27 1841.11 2607.27 1848.24 Q2607.27 1855.34 2609.07 1858.91 Q2610.9 1862.45 2614.51 1862.45 Q2618.15 1862.45 2619.95 1858.91 Q2621.78 1855.34 2621.78 1848.24 Q2621.78 1841.11 2619.95 1837.57 Q2618.15 1834 2614.51 1834 M2614.51 1830.3 Q2620.32 1830.3 2623.38 1834.9 Q2626.46 1839.49 2626.46 1848.24 Q2626.46 1856.96 2623.38 1861.57 Q2620.32 1866.15 2614.51 1866.15 Q2608.7 1866.15 2605.62 1861.57 Q2602.57 1856.96 2602.57 1848.24 Q2602.57 1839.49 2605.62 1834.9 Q2608.7 1830.3 2614.51 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,1520.61 2640.76,1520.61 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,1218.98 2640.76,1218.98 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,917.357 2640.76,917.357 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,615.731 2640.76,615.731 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,314.105 2640.76,314.105 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1800.78 151.747,47.2441 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1520.61 170.644,1520.61 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1218.98 170.644,1218.98 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,917.357 170.644,917.357 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,615.731 170.644,615.731 "></polyline>
<polyline clip-path="url(#clip170)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,314.105 170.644,314.105 "></polyline>
<path clip-path="url(#clip170)" d="M49.5521 1521.06 L79.2279 1521.06 L79.2279 1525 L49.5521 1525 L49.5521 1521.06 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M99.8991 1518.75 Q96.7509 1518.75 94.8991 1520.9 Q93.0704 1523.05 93.0704 1526.8 Q93.0704 1530.53 94.8991 1532.7 Q96.7509 1534.86 99.8991 1534.86 Q103.047 1534.86 104.876 1532.7 Q106.728 1530.53 106.728 1526.8 Q106.728 1523.05 104.876 1520.9 Q103.047 1518.75 99.8991 1518.75 M109.181 1504.09 L109.181 1508.35 Q107.422 1507.52 105.617 1507.08 Q103.834 1506.64 102.075 1506.64 Q97.4454 1506.64 94.9917 1509.76 Q92.5612 1512.89 92.2139 1519.21 Q93.5797 1517.2 95.6398 1516.13 Q97.7 1515.04 100.177 1515.04 Q105.385 1515.04 108.394 1518.21 Q111.427 1521.36 111.427 1526.8 Q111.427 1532.13 108.279 1535.34 Q105.131 1538.56 99.8991 1538.56 Q93.9037 1538.56 90.7325 1533.98 Q87.5612 1529.37 87.5612 1520.64 Q87.5612 1512.45 91.45 1507.59 Q95.3389 1502.7 101.89 1502.7 Q103.649 1502.7 105.431 1503.05 Q107.237 1503.4 109.181 1504.09 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M50.3623 1219.43 L80.0381 1219.43 L80.0381 1223.37 L50.3623 1223.37 L50.3623 1219.43 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M104.297 1217.63 Q107.654 1218.35 109.529 1220.62 Q111.427 1222.88 111.427 1226.22 Q111.427 1231.33 107.908 1234.13 Q104.39 1236.93 97.9083 1236.93 Q95.7324 1236.93 93.4176 1236.49 Q91.126 1236.08 88.6723 1235.22 L88.6723 1230.71 Q90.6167 1231.84 92.9315 1232.42 Q95.2463 1233 97.7695 1233 Q102.168 1233 104.459 1231.26 Q106.774 1229.53 106.774 1226.22 Q106.774 1223.16 104.621 1221.45 Q102.492 1219.71 98.6722 1219.71 L94.6445 1219.71 L94.6445 1215.87 L98.8574 1215.87 Q102.306 1215.87 104.135 1214.5 Q105.964 1213.12 105.964 1210.52 Q105.964 1207.86 104.066 1206.45 Q102.191 1205.01 98.6722 1205.01 Q96.7509 1205.01 94.5519 1205.43 Q92.3528 1205.85 89.7139 1206.73 L89.7139 1202.56 Q92.376 1201.82 94.6908 1201.45 Q97.0287 1201.08 99.0889 1201.08 Q104.413 1201.08 107.515 1203.51 Q110.617 1205.92 110.617 1210.04 Q110.617 1212.91 108.973 1214.9 Q107.33 1216.87 104.297 1217.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M99.4824 903.156 Q95.8713 903.156 94.0426 906.721 Q92.2371 910.262 92.2371 917.392 Q92.2371 924.498 94.0426 928.063 Q95.8713 931.605 99.4824 931.605 Q103.117 931.605 104.922 928.063 Q106.751 924.498 106.751 917.392 Q106.751 910.262 104.922 906.721 Q103.117 903.156 99.4824 903.156 M99.4824 899.452 Q105.293 899.452 108.348 904.059 Q111.427 908.642 111.427 917.392 Q111.427 926.119 108.348 930.725 Q105.293 935.308 99.4824 935.308 Q93.6723 935.308 90.5936 930.725 Q87.538 926.119 87.538 917.392 Q87.538 908.642 90.5936 904.059 Q93.6723 899.452 99.4824 899.452 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M104.297 614.377 Q107.654 615.094 109.529 617.363 Q111.427 619.631 111.427 622.965 Q111.427 628.08 107.908 630.881 Q104.39 633.682 97.9083 633.682 Q95.7324 633.682 93.4176 633.242 Q91.126 632.826 88.6723 631.969 L88.6723 627.455 Q90.6167 628.59 92.9315 629.168 Q95.2463 629.747 97.7695 629.747 Q102.168 629.747 104.459 628.011 Q106.774 626.275 106.774 622.965 Q106.774 619.909 104.621 618.196 Q102.492 616.46 98.6722 616.46 L94.6445 616.46 L94.6445 612.618 L98.8574 612.618 Q102.306 612.618 104.135 611.252 Q105.964 609.863 105.964 607.27 Q105.964 604.608 104.066 603.196 Q102.191 601.761 98.6722 601.761 Q96.7509 601.761 94.5519 602.178 Q92.3528 602.594 89.7139 603.474 L89.7139 599.307 Q92.376 598.567 94.6908 598.196 Q97.0287 597.826 99.0889 597.826 Q104.413 597.826 107.515 600.257 Q110.617 602.664 110.617 606.784 Q110.617 609.655 108.973 611.645 Q107.33 613.613 104.297 614.377 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip170)" d="M99.8991 312.241 Q96.7509 312.241 94.8991 314.394 Q93.0704 316.547 93.0704 320.297 Q93.0704 324.024 94.8991 326.2 Q96.7509 328.352 99.8991 328.352 Q103.047 328.352 104.876 326.2 Q106.728 324.024 106.728 320.297 Q106.728 316.547 104.876 314.394 Q103.047 312.241 99.8991 312.241 M109.181 297.589 L109.181 301.848 Q107.422 301.015 105.617 300.575 Q103.834 300.135 102.075 300.135 Q97.4454 300.135 94.9917 303.26 Q92.5612 306.385 92.2139 312.704 Q93.5797 310.69 95.6398 309.626 Q97.7 308.538 100.177 308.538 Q105.385 308.538 108.394 311.709 Q111.427 314.857 111.427 320.297 Q111.427 325.621 108.279 328.839 Q105.131 332.056 99.8991 332.056 Q93.9037 332.056 90.7325 327.473 Q87.5612 322.866 87.5612 314.14 Q87.5612 305.945 91.45 301.084 Q95.3389 296.2 101.89 296.2 Q103.649 296.2 105.431 296.547 Q107.237 296.894 109.181 297.589 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip172)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,1245.26 224.541,1540.09 226.891,1513.88 229.242,1515.31 231.592,1412.48 233.943,1455.93 236.293,1394.83 238.644,1462.43 240.994,1497.11 243.345,1402.69 245.695,1322.14 248.046,1267.22 250.396,1321.15 252.747,1344.5 255.097,1475.2 257.448,1321.94 259.798,1348.47 262.148,1610.29 264.499,1313.06 266.849,1354.49 269.2,1524.78 271.55,1410.84 273.901,1390.06 276.251,1632.27 278.602,1343.28 280.952,1370.96 283.303,1454.28 285.653,1476.65 288.004,1536.43 290.354,1449.46 292.705,1493.96 295.055,1339.92 297.406,1495.68 299.756,1459.52 302.107,1615.42 304.457,1327.73 306.807,1538.07 309.158,1478.43 311.508,1496.21 313.859,1384.64 316.209,1453.86 318.56,1427.96 320.91,1477.36 323.261,1608.01 325.611,1506.86 327.962,1395.45 330.312,1482.44 332.663,1276.57 335.013,1269.72 337.364,1602.22 339.714,1249.83 342.065,1491.71 344.415,1467.55 346.765,1438.66 349.116,1342.47 351.466,1308.4 353.817,1368.18 356.167,1211.49 358.518,1438.08 360.868,1548.17 363.219,1392.27 365.569,1373.72 367.92,1358.12 370.27,1426.41 372.621,1403.27 374.971,1361.23 377.322,1393.83 379.672,1529.14 382.023,1329.96 384.373,1307.45 386.724,1433.24 389.074,1364.56 391.424,1486.16 393.775,1414.08 396.125,1625.42 398.476,1287.98 400.826,1530.24 403.177,1360.1 405.527,1446.49 407.878,1302.43 410.228,1334.06 412.579,1514.86 414.929,1397.5 417.28,1312.44 419.63,1449.52 421.981,1358.3 424.331,1344.07 426.682,1432.28 429.032,1397.72 431.382,1455.29 433.733,1405.42 436.083,1357.04 438.434,1432.49 440.784,1539.05 443.135,1384.06 445.485,1365.14 447.836,1466.47 450.186,1626.86 452.537,1751.15 454.887,1476.59 457.238,1391.79 459.588,1324.22 461.939,1580.55 464.289,1393.59 466.64,1439.69 468.99,1438.79 471.341,1551.3 473.691,1458.59 476.041,1588.43 478.392,1459.12 480.742,1457.68 483.093,1316.06 485.443,1447.66 487.794,1381.91 490.144,1302.94 492.495,1289.47 494.845,1512.97 497.196,1549.62 499.546,1392.56 501.897,1592.69 504.247,1411.05 506.598,1456.75 508.948,1231.21 511.299,1476.76 513.649,1334.38 515.999,1505.86 518.35,1608.14 520.7,1654.69 523.051,1600.42 525.401,1562.55 527.752,1325.1 530.102,1536.73 532.453,1299.8 534.803,1277.53 537.154,1512.42 539.504,1366.86 541.855,1428.98 544.205,1252.4 546.556,1282.53 548.906,1498.38 551.257,1385.68 553.607,1476.76 555.958,1436.15 558.308,1395.14 560.658,1539.74 563.009,1494.91 565.359,1368.32 567.71,1412.24 570.06,1151.19 572.411,1387.41 574.761,1356.61 577.112,1512.59 579.462,1523.75 581.813,1475.54 584.163,1400.5 586.514,1329.52 588.864,1321.16 591.215,1436.64 593.565,1252.47 595.916,1333.01 598.266,1492.65 600.616,1327.34 602.967,1466.76 605.317,1430.46 607.668,1472 610.018,1565.11 612.369,1542.59 614.719,1338.25 617.07,1388.96 619.42,1429.11 621.771,1335 624.121,1532.87 626.472,1244.08 628.822,1396.16 631.173,1436.55 633.523,1601.88 635.874,1363.01 638.224,1490.38 640.575,1406.08 642.925,1495.64 645.275,1363.56 647.626,1490.33 649.976,1269.2 652.327,1367.92 654.677,1451.35 657.028,1438.78 659.378,1289.41 661.729,1306.64 664.079,1364.52 666.43,1477.63 668.78,1543.05 671.131,1261.79 673.481,1430.71 675.832,1518.67 678.182,1452.41 680.533,1402.47 682.883,1378.89 685.233,1485.32 687.584,1365.77 689.934,1575.54 692.285,1507.34 694.635,1414.26 696.986,1391.2 699.336,1213.16 701.687,1549.99 704.037,1555.25 706.388,1199.59 708.738,1547.28 711.089,1371.44 713.439,1425.81 715.79,1440.37 718.14,1378.42 720.491,1427.65 722.841,1443.13 725.192,1247.66 727.542,1472.07 729.892,1422.07 732.243,1172.77 734.593,1473.53 736.944,1436.95 739.294,1328.15 741.645,1293.68 743.995,1463.11 746.346,1562.95 748.696,1352.48 751.047,1424.29 753.397,1271.78 755.748,1439.99 758.098,1448.68 760.449,1475.36 762.799,1505.51 765.15,1258.04 767.5,1309.5 769.85,1359.76 772.201,1598.32 774.551,1557.72 776.902,1474.16 779.252,1442.29 781.603,1213.36 783.953,1546.63 786.304,1521.53 788.654,1232.01 791.005,1324.15 793.355,1369.41 795.706,1390.21 798.056,1673.71 800.407,1442.23 802.757,1269.93 805.108,1365.76 807.458,1459.12 809.809,1346.2 812.159,1444.59 814.509,1408.15 816.86,1244.62 819.21,1450.78 821.561,1387.69 823.911,1400.9 826.262,1499.68 828.612,1472.99 830.963,1493.45 833.313,1462.58 835.664,1339.12 838.014,1306.4 840.365,1432.65 842.715,1422.36 845.066,1481.5 847.416,1485.13 849.767,1479.2 852.117,1271.16 854.467,1487.92 856.818,1323.3 859.168,1321.11 861.519,1580.39 863.869,1386.05 866.22,1130.25 868.57,1558.22 870.921,1487.87 873.271,1610.44 875.622,1466.61 877.972,1382.08 880.323,1516.16 882.673,1359.99 885.024,1436.47 887.374,1563.23 889.725,1438.2 892.075,1603.68 894.426,1459.05 896.776,1470.26 899.126,1399.59 901.477,1485.18 903.827,1341.03 906.178,1600.11 908.528,1505.47 910.879,1485.4 913.229,1516.48 915.58,1417.19 917.93,1592.99 920.281,1514.04 922.631,1506.09 924.982,1414.34 927.332,1396.49 929.683,1247.38 932.033,1370.96 934.384,1522.38 936.734,1373.36 939.084,1288.53 941.435,1512.57 943.785,1450.94 946.136,1347.92 948.486,1519.66 950.837,1512.72 953.187,1147.64 955.538,1489.11 957.888,1515.9 960.239,1488.22 962.589,1609.51 964.94,1469.99 967.29,1469.27 969.641,1431.15 971.991,1302.95 974.342,1552.23 976.692,1410.49 979.043,1465.28 981.393,1381.96 983.743,1413.67 986.094,1585.13 988.444,1576.29 990.795,1386.91 993.145,1389.2 995.496,1448.86 997.846,1338.26 1000.2,1602.16 1002.55,1311.03 1004.9,1382.27 1007.25,1532.78 1009.6,1363.07 1011.95,1611.52 1014.3,1415.78 1016.65,1514.26 1019,1292.28 1021.35,1430.29 1023.7,1391.51 1026.05,1516.26 1028.4,1494.17 1030.75,1546.78 1033.1,1349.98 1035.45,1396.89 1037.8,1317.76 1040.15,1407.26 1042.51,1435.3 1044.86,1455.35 1047.21,1291.59 1049.56,1413.87 1051.91,1535.83 1054.26,1452.48 1056.61,1566.15 1058.96,1334.76 1061.31,1579.57 1063.66,1206.2 1066.01,1546.48 1068.36,1396.29 1070.71,1550.61 1073.06,1317.56 1075.41,1506.82 1077.76,1371.37 1080.11,1429.93 1082.46,1692.35 1084.81,1393.78 1087.16,1354.93 1089.51,1449.18 1091.87,1311.45 1094.22,1437.93 1096.57,1434.31 1098.92,1490.16 1101.27,1305.88 1103.62,1272.07 1105.97,1407.19 1108.32,1543.76 1110.67,1435.39 1113.02,1312.19 1115.37,1452.49 1117.72,1468.3 1120.07,1414.05 1122.42,1644.69 1124.77,1437.26 1127.12,1405.4 1129.47,1407.67 1131.82,1372.85 1134.17,1447.15 1136.52,1510.43 1138.87,1632.76 1141.23,1444.76 1143.58,1298.18 1145.93,1315.69 1148.28,1516.73 1150.63,1498.01 1152.98,1308.21 1155.33,1487.24 1157.68,1736.32 1160.03,1376.01 1162.38,1496.55 1164.73,1458.05 1167.08,1373.06 1169.43,1321.95 1171.78,1316.82 1174.13,1365.01 1176.48,1423.04 1178.83,1374.13 1181.18,1346.46 1183.53,1366.32 1185.88,1607.53 1188.23,1470.37 1190.59,1550.72 1192.94,1433.41 1195.29,1472.69 1197.64,1383.72 1199.99,1655.75 1202.34,1317.24 1204.69,1404.56 1207.04,1471.17 1209.39,1495.64 1211.74,1382.68 1214.09,1526.38 1216.44,1648.51 1218.79,1576.55 1221.14,1110.04 1223.49,1643.31 1225.84,1352.51 1228.19,1572.5 1230.54,1357.87 1232.89,1353.31 1235.24,1310.43 1237.59,1406.25 1239.94,1524.14 1242.3,1444.37 1244.65,1422.36 1247,1362.81 1249.35,1282.46 1251.7,1369.77 1254.05,1408.85 1256.4,1363.7 1258.75,1545.25 1261.1,1344.94 1263.45,1255 1265.8,1334.14 1268.15,1473.11 1270.5,1352.56 1272.85,1406.95 1275.2,1317.03 1277.55,1368.95 1279.9,1405.74 1282.25,1523.55 1284.6,1445.76 1286.95,1363.6 1289.3,1420.13 1291.66,1515.11 1294.01,1101.34 1296.36,1316.71 1298.71,1320.04 1301.06,1372.88 1303.41,1234.88 1305.76,1498.13 1308.11,1405.74 1310.46,1419.14 1312.81,1382.81 1315.16,1334.39 1317.51,1410.34 1319.86,1624.55 1322.21,1303.8 1324.56,1364.68 1326.91,1350.28 1329.26,1431.8 1331.61,1517.14 1333.96,1489.54 1336.31,1191.61 1338.66,1308.26 1341.02,1399.86 1343.37,1552.11 1345.72,1512.42 1348.07,1396.11 1350.42,1293.65 1352.77,1409.06 1355.12,1496.16 1357.47,1534.79 1359.82,1457.11 1362.17,1240.59 1364.52,1516.35 1366.87,1570.07 1369.22,1721.73 1371.57,1330.43 1373.92,1434.18 1376.27,1590.53 1378.62,1459.56 1380.97,1527.44 1383.32,1328.26 1385.67,1303.47 1388.02,1440.04 1390.38,1419.99 1392.73,1400.39 1395.08,1335.99 1397.43,1423.9 1399.78,1360.17 1402.13,1434.65 1404.48,1610.35 1406.83,1270.25 1409.18,1304.43 1411.53,1535.46 1413.88,1505.84 1416.23,1537.5 1418.58,1394.57 1420.93,1448.15 1423.28,1322.97 1425.63,1514.83 1427.98,1416.8 1430.33,1399.93 1432.68,1294.66 1435.03,1515.96 1437.38,1365.35 1439.74,1267.43 1442.09,1340.21 1444.44,1400.28 1446.79,1495.17 1449.14,1401.32 1451.49,1424.3 1453.84,1203.09 1456.19,1321.8 1458.54,1368.01 1460.89,1682.09 1463.24,1463.49 1465.59,1341.03 1467.94,1114.61 1470.29,1307.33 1472.64,1487.23 1474.99,1537.19 1477.34,1499.56 1479.69,1565.28 1482.04,1380.7 1484.39,1279.49 1486.74,1452.95 1489.1,1140.93 1491.45,1467.15 1493.8,1344.98 1496.15,1387.64 1498.5,1173.77 1500.85,1266.44 1503.2,1417.03 1505.55,1266.91 1507.9,1405 1510.25,1345 1512.6,1537.43 1514.95,1292.42 1517.3,1462.4 1519.65,1342.61 1522,1401.91 1524.35,1471.6 1526.7,1449.03 1529.05,1432.69 1531.4,1388.71 1533.75,1419.78 1536.1,1343.51 1538.45,1403.82 1540.81,1362.46 1543.16,1360.8 1545.51,1315.88 1547.86,1393.54 1550.21,1643.32 1552.56,1412.57 1554.91,1473.72 1557.26,1361.46 1559.61,1512.12 1561.96,1213.79 1564.31,1342.96 1566.66,1502.82 1569.01,1651.77 1571.36,1524.91 1573.71,1666.16 1576.06,1452.94 1578.41,1308.75 1580.76,1399.36 1583.11,1285.37 1585.46,1453.92 1587.81,1484.56 1590.17,1360.93 1592.52,1470.7 1594.87,1365.22 1597.22,1266.55 1599.57,1292.56 1601.92,1448.22 1604.27,1395.67 1606.62,1571.7 1608.97,1379.85 1611.32,1538.83 1613.67,1394.09 1616.02,1486.63 1618.37,1463.9 1620.72,1377.67 1623.07,1380.17 1625.42,1413.23 1627.77,1403.03 1630.12,1406.55 1632.47,1374.06 1634.82,1458.89 1637.17,1470.18 1639.53,1464.37 1641.88,1369.21 1644.23,1407.62 1646.58,1545.45 1648.93,1494.96 1651.28,1477.54 1653.63,1467.5 1655.98,1559.64 1658.33,1329.75 1660.68,1292.5 1663.03,1225.41 1665.38,1343.73 1667.73,1481.61 1670.08,1350.62 1672.43,1370.84 1674.78,1562.14 1677.13,1366.24 1679.48,1363.15 1681.83,1306.45 1684.18,1444.49 1686.53,1519.62 1688.89,1487.9 1691.24,1154.74 1693.59,1409.43 1695.94,1437.77 1698.29,1488.23 1700.64,1648.57 1702.99,1513.55 1705.34,1411.91 1707.69,1464.45 1710.04,1362.35 1712.39,1313.1 1714.74,1458.8 1717.09,1511.3 1719.44,1364.15 1721.79,1416.42 1724.14,1360.57 1726.49,1323.69 1728.84,1409.26 1731.19,1435.3 1733.54,1449.05 1735.89,1509.39 1738.25,1611.96 1740.6,1400.73 1742.95,1573.25 1745.3,1491.96 1747.65,1429.74 1750,1411.84 1752.35,1338.82 1754.7,1447.78 1757.05,1344.18 1759.4,1538.98 1761.75,1253.27 1764.1,1488.89 1766.45,1560.44 1768.8,1387.92 1771.15,1481.79 1773.5,1470.63 1775.85,1622.21 1778.2,1369.05 1780.55,1370.82 1782.9,1478.56 1785.25,1431.01 1787.6,1605.09 1789.96,1520.55 1792.31,1372.09 1794.66,1313.95 1797.01,1401.46 1799.36,1278.22 1801.71,1391.39 1804.06,1406.78 1806.41,1484.38 1808.76,1447.59 1811.11,1054.12 1813.46,1378.01 1815.81,1529 1818.16,1267.55 1820.51,1434.79 1822.86,1255.97 1825.21,1501.24 1827.56,1511.86 1829.91,1354.11 1832.26,1538.06 1834.61,1524.58 1836.96,1371.15 1839.32,1446.43 1841.67,1425.8 1844.02,1401.67 1846.37,1204.3 1848.72,1544.39 1851.07,1401.54 1853.42,1339.15 1855.77,1591.63 1858.12,1425.09 1860.47,1313.46 1862.82,1403.83 1865.17,1448.67 1867.52,1351.37 1869.87,1476.57 1872.22,1246.08 1874.57,1453.82 1876.92,1252.63 1879.27,1210.26 1881.62,1349.06 1883.97,1474.27 1886.32,1591.05 1888.68,1511.64 1891.03,1541.55 1893.38,1343.48 1895.73,1349.75 1898.08,1446.83 1900.43,1062.24 1902.78,1365.41 1905.13,1368.1 1907.48,1449.56 1909.83,1520.39 1912.18,1400.85 1914.53,1480.05 1916.88,1500.54 1919.23,1425.18 1921.58,1401.57 1923.93,1666.76 1926.28,1395.67 1928.63,1614.87 1930.98,1346.72 1933.33,1506.1 1935.68,1408.54 1938.04,1365.06 1940.39,1506.86 1942.74,1293.11 1945.09,1419.18 1947.44,1485.36 1949.79,1530.97 1952.14,1516.89 1954.49,1357.06 1956.84,1352.31 1959.19,1332.03 1961.54,1173.71 1963.89,1319.79 1966.24,1475.57 1968.59,1269.25 1970.94,1564.72 1973.29,1404.76 1975.64,1380.32 1977.99,1363.91 1980.34,1279.74 1982.69,1474.89 1985.04,1307.3 1987.4,1392.27 1989.75,1483.09 1992.1,1358.99 1994.45,1504.76 1996.8,1515.7 1999.15,1357.77 2001.5,1489.79 2003.85,1379.21 2006.2,1426.71 2008.55,1301.01 2010.9,1369.23 2013.25,1419.87 2015.6,1492.68 2017.95,1322.85 2020.3,1391.48 2022.65,1461.38 2025,1281.01 2027.35,1452.49 2029.7,1319.76 2032.05,1546.49 2034.4,1567.42 2036.76,1295.53 2039.11,1525 2041.46,1709.34 2043.81,1482.84 2046.16,1569 2048.51,1406.45 2050.86,1410.1 2053.21,1146.65 2055.56,1330.06 2057.91,1504.12 2060.26,1442.24 2062.61,1500.78 2064.96,1236.14 2067.31,1466.31 2069.66,1443.45 2072.01,1522.86 2074.36,1295.99 2076.71,1491.81 2079.06,1366.3 2081.41,1443.1 2083.76,1529.24 2086.11,1437.71 2088.47,1552.61 2090.82,1429.17 2093.17,1383.07 2095.52,1541.8 2097.87,1463.84 2100.22,1415.75 2102.57,1504.67 2104.92,1428.19 2107.27,1446.07 2109.62,1568.7 2111.97,1345.14 2114.32,1412.97 2116.67,1349.86 2119.02,1405.52 2121.37,1431.32 2123.72,1411.03 2126.07,1271.67 2128.42,1289.64 2130.77,1581.91 2133.12,1568.02 2135.47,1288.59 2137.83,1508.06 2140.18,1501.13 2142.53,1382.47 2144.88,1558.38 2147.23,1336.98 2149.58,1551.31 2151.93,1554.9 2154.28,1336.72 2156.63,1568.95 2158.98,1537.95 2161.33,1486.71 2163.68,1385.67 2166.03,1523.91 2168.38,1342.16 2170.73,1514.26 2173.08,1224.86 2175.43,1596.15 2177.78,1370.82 2180.13,1533.13 2182.48,1251.1 2184.83,1413.11 2187.19,1287.88 2189.54,1303.28 2191.89,1297.6 2194.24,1307.18 2196.59,1439.91 2198.94,1420.49 2201.29,1305.32 2203.64,1442.79 2205.99,1335.26 2208.34,1365.26 2210.69,1229.56 2213.04,1333.37 2215.39,1312.61 2217.74,1277.49 2220.09,1525.39 2222.44,1467.01 2224.79,1306.58 2227.14,1512.87 2229.49,1380.95 2231.84,1385.34 2234.19,1364.89 2236.55,1442.28 2238.9,1575.76 2241.25,1435.54 2243.6,1481.05 2245.95,1452.65 2248.3,1477.13 2250.65,1400.37 2253,1419.69 2255.35,1429.51 2257.7,1303.73 2260.05,1361.68 2262.4,1545.74 2264.75,1535.89 2267.1,1380.13 2269.45,1412.89 2271.8,1335.34 2274.15,1485.14 2276.5,1556.77 2278.85,1526.6 2281.2,1480.06 2283.55,1502.17 2285.91,1430.04 2288.26,1352.67 2290.61,1447.78 2292.96,1294.08 2295.31,1249.14 2297.66,1384.27 2300.01,1437.01 2302.36,1614.63 2304.71,1419.18 2307.06,1397.15 2309.41,1551.71 2311.76,1277.28 2314.11,1432.41 2316.46,1418.68 2318.81,1520.1 2321.16,1501.55 2323.51,1609.9 2325.86,1445.15 2328.21,1363.48 2330.56,1369.89 2332.91,1490.58 2335.27,1551.69 2337.62,1330.65 2339.97,1458.4 2342.32,1304.8 2344.67,1467.68 2347.02,1501.46 2349.37,1403.9 2351.72,1347.18 2354.07,1540.38 2356.42,1332.22 2358.77,1424.89 2361.12,1476.8 2363.47,1487.97 2365.82,1335.23 2368.17,1497.86 2370.52,1482.86 2372.87,1496.41 2375.22,1244.46 2377.57,1411.72 2379.92,1315.69 2382.27,1445 2384.62,1422.15 2386.98,1514.8 2389.33,1345.8 2391.68,1281.98 2394.03,1208.51 2396.38,1457.26 2398.73,1334 2401.08,1373.24 2403.43,1460.12 2405.78,1524.74 2408.13,1313.23 2410.48,1442.98 2412.83,1362.82 2415.18,1407.43 2417.53,1510.76 2419.88,1429.61 2422.23,1541.5 2424.58,1504.56 2426.93,1311.37 2429.28,1416.86 2431.63,1632.38 2433.98,1605.94 2436.34,1229.1 2438.69,1539.57 2441.04,1463.18 2443.39,1322.74 2445.74,1446.02 2448.09,1671.83 2450.44,1542.09 2452.79,1241.63 2455.14,1394.15 2457.49,1493.38 2459.84,1411.78 2462.19,1352.29 2464.54,1312.59 2466.89,1338.51 2469.24,1291.66 2471.59,1255.05 2473.94,1327.46 2476.29,1606.95 2478.64,1456.59 2480.99,1407.06 2483.34,1314.97 2485.7,1389.64 2488.05,1415.7 2490.4,1291.38 2492.75,1504.99 2495.1,1470.88 2497.45,1467.7 2499.8,1357.06 2502.15,1416.32 2504.5,1391.32 2506.85,1739.88 2509.2,1447.44 2511.55,1592.77 2513.9,1306.22 2516.25,1263.18 2518.6,1234.36 2520.95,1594.08 2523.3,1324.55 2525.65,1481.84 2528,1527.47 2530.35,1211.94 2532.7,1403.77 2535.06,1361.42 2537.41,1582.22 2539.76,1571.79 2542.11,1294.96 2544.46,1450.9 2546.81,1517.3 2549.16,1521.88 2551.51,1371.41 2553.86,1425.45 2556.21,1371.86 2558.56,1443.56 2560.91,1361.36 2563.26,1419.87 2565.61,1360.58 2567.96,1550.87 2570.31,1548.44 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,1000.45 224.541,770.582 226.891,918.4 229.242,877.935 231.592,1073.54 233.943,1095.91 236.293,865.274 238.644,1001.4 240.994,941.223 243.345,856.194 245.695,788.65 248.046,968.019 250.396,894.391 252.747,807.478 255.097,901.848 257.448,1027.76 259.798,795.038 262.148,935.432 264.499,803.903 266.849,1071.36 269.2,957.252 271.55,949.574 273.901,889.659 276.251,877.273 278.602,931.646 280.952,1018.96 283.303,1083.85 285.653,942.292 288.004,877.621 290.354,861.6 292.705,1036.39 295.055,972.883 297.406,1039.35 299.756,925.58 302.107,874.581 304.457,840.713 306.807,1029.02 309.158,1062.98 311.508,937.336 313.859,982.642 316.209,898.575 318.56,876.412 320.91,860.718 323.261,1074.58 325.611,840.172 327.962,929.71 330.312,838.843 332.663,1048.24 335.013,971.849 337.364,779.889 339.714,720.949 342.065,951.443 344.415,909.454 346.765,899.659 349.116,877.26 351.466,921.445 353.817,813.871 356.167,1104.83 358.518,948.507 360.868,904.021 363.219,871.902 365.569,794.219 367.92,925.602 370.27,933.727 372.621,994.693 374.971,879.713 377.322,1027.12 379.672,707.193 382.023,998.518 384.373,981.494 386.724,1023.94 389.074,838.524 391.424,939.249 393.775,988.092 396.125,1079.46 398.476,1095.8 400.826,810.528 403.177,811.795 405.527,826.558 407.878,1089.8 410.228,871.688 412.579,963.418 414.929,1040.02 417.28,975.355 419.63,1204.92 421.981,850.865 424.331,1049.59 426.682,966.012 429.032,953.855 431.382,858.723 433.733,915.597 436.083,701.783 438.434,910.009 440.784,1057.73 443.135,897.149 445.485,890.561 447.836,987.811 450.186,1007.05 452.537,1051.66 454.887,970.27 457.238,971.301 459.588,808.935 461.939,789.362 464.289,1025.37 466.64,910.236 468.99,854.375 471.341,828.326 473.691,913.762 476.041,985.958 478.392,941.074 480.742,831.509 483.093,986.04 485.443,1068.26 487.794,992.232 490.144,860.025 492.495,994.184 494.845,727.974 497.196,872.094 499.546,833.915 501.897,916.818 504.247,796.23 506.598,859.496 508.948,990.76 511.299,807.574 513.649,875.431 515.999,960.255 518.35,910.917 520.7,1197.32 523.051,837.633 525.401,963.628 527.752,940.533 530.102,1013.7 532.453,822.915 534.803,800.465 537.154,926.768 539.504,960.689 541.855,1080.62 544.205,964.602 546.556,985.646 548.906,849.137 551.257,874.465 553.607,1108.37 555.958,685.541 558.308,999.478 560.658,903.048 563.009,964.289 565.359,744.218 567.71,1134 570.06,1098.25 572.411,936.197 574.761,1054.86 577.112,893.228 579.462,1014.92 581.813,833.389 584.163,816.506 586.514,823.458 588.864,822.453 591.215,728.2 593.565,915.167 595.916,843.229 598.266,891.922 600.616,1179.72 602.967,774.091 605.317,1016.47 607.668,952.289 610.018,921.74 612.369,948.304 614.719,837.634 617.07,1058.6 619.42,859.87 621.771,827.654 624.121,990.481 626.472,1054.77 628.822,849.505 631.173,948.975 633.523,867.802 635.874,852.749 638.224,855.948 640.575,1039.72 642.925,879.55 645.275,1042.54 647.626,979.745 649.976,858.135 652.327,757.048 654.677,1079 657.028,973.438 659.378,1015.85 661.729,869.701 664.079,889.96 666.43,838.08 668.78,1035.8 671.131,855.86 673.481,944.271 675.832,953.466 678.182,858.961 680.533,904.879 682.883,1015.39 685.233,957.42 687.584,902.955 689.934,772.766 692.285,903.18 694.635,996.847 696.986,824.955 699.336,1025.88 701.687,856.826 704.037,820.557 706.388,916.322 708.738,915.882 711.089,974.524 713.439,977.677 715.79,978.344 718.14,1024.02 720.491,826.472 722.841,789.358 725.192,887.448 727.542,911.482 729.892,935.321 732.243,802.235 734.593,976.482 736.944,1055.13 739.294,999.283 741.645,867.732 743.995,844.154 746.346,842.918 748.696,986.124 751.047,781.38 753.397,873.359 755.748,946.981 758.098,903.076 760.449,983.478 762.799,940.402 765.15,840.705 767.5,992.386 769.85,905.705 772.201,1013.99 774.551,808.002 776.902,913.428 779.252,1004.48 781.603,875.605 783.953,963.288 786.304,772.886 788.654,974.608 791.005,685.118 793.355,1024.36 795.706,749.608 798.056,1016.55 800.407,907.836 802.757,862.813 805.108,829.831 807.458,830.787 809.809,855.601 812.159,784.43 814.509,1181.02 816.86,861.482 819.21,875.086 821.561,1003.38 823.911,966.778 826.262,859.047 828.612,965.379 830.963,1016.56 833.313,947.315 835.664,860.298 838.014,788.39 840.365,1051.1 842.715,964.941 845.066,904.14 847.416,805.689 849.767,906.639 852.117,869.802 854.467,940.92 856.818,1014.14 859.168,801.218 861.519,889.191 863.869,1042.59 866.22,1160.54 868.57,974.672 870.921,950.513 873.271,1017.66 875.622,1044.3 877.972,868.445 880.323,1003.4 882.673,901.286 885.024,927.595 887.374,954.57 889.725,774.717 892.075,858.34 894.426,942.72 896.776,890.824 899.126,968.733 901.477,1007.49 903.827,908.104 906.178,1147.4 908.528,822.389 910.879,1126.66 913.229,800.866 915.58,908.761 917.93,817.316 920.281,990.626 922.631,1126.52 924.982,1122.44 927.332,851.907 929.683,828.265 932.033,949.164 934.384,918.084 936.734,1004.13 939.084,979.587 941.435,805.929 943.785,1034.26 946.136,896.936 948.486,850.419 950.837,823.501 953.187,852.108 955.538,860.293 957.888,1082.83 960.239,766.279 962.589,841.471 964.94,777.145 967.29,1039.58 969.641,774.355 971.991,934.97 974.342,1082.88 976.692,751.577 979.043,1163.03 981.393,1049.26 983.743,788.657 986.094,896.439 988.444,755.898 990.795,819.872 993.145,1029.71 995.496,951.603 997.846,790.074 1000.2,1066.97 1002.55,902.09 1004.9,952.528 1007.25,925.637 1009.6,944.889 1011.95,715.781 1014.3,1026.14 1016.65,740.096 1019,1016.39 1021.35,1009.92 1023.7,989.624 1026.05,846.936 1028.4,942.092 1030.75,770.821 1033.1,992.087 1035.45,875.731 1037.8,875.942 1040.15,994.636 1042.51,1073.69 1044.86,877.893 1047.21,981.883 1049.56,801.903 1051.91,971.113 1054.26,843.669 1056.61,827.98 1058.96,955.955 1061.31,950.511 1063.66,963.139 1066.01,996.06 1068.36,895.014 1070.71,998.952 1073.06,787.422 1075.41,905.901 1077.76,922.347 1080.11,1118.36 1082.46,967.281 1084.81,872.499 1087.16,890.484 1089.51,886.99 1091.87,662.976 1094.22,919.571 1096.57,991.821 1098.92,770.776 1101.27,819.609 1103.62,979.951 1105.97,842.787 1108.32,807.641 1110.67,865.583 1113.02,951.78 1115.37,1030.26 1117.72,915.009 1120.07,975.773 1122.42,843.09 1124.77,891.423 1127.12,871.253 1129.47,985.101 1131.82,999.192 1134.17,829.054 1136.52,852.583 1138.87,958.089 1141.23,941.28 1143.58,726.736 1145.93,1095.13 1148.28,990.408 1150.63,902.559 1152.98,904.976 1155.33,1008.95 1157.68,1002.44 1160.03,986.176 1162.38,991.926 1164.73,838.89 1167.08,988.135 1169.43,886.765 1171.78,975.538 1174.13,967.032 1176.48,850.17 1178.83,810.944 1181.18,769.26 1183.53,893.279 1185.88,870.278 1188.23,711.685 1190.59,950.171 1192.94,930.575 1195.29,905.814 1197.64,934.638 1199.99,768.926 1202.34,1043.06 1204.69,932.688 1207.04,832.305 1209.39,982.482 1211.74,1069.78 1214.09,946.133 1216.44,909.868 1218.79,954.524 1221.14,832.354 1223.49,1007.83 1225.84,814.253 1228.19,1090.18 1230.54,821.049 1232.89,970.93 1235.24,940.193 1237.59,1014.71 1239.94,856.033 1242.3,1053.86 1244.65,1065.7 1247,963.188 1249.35,1081.14 1251.7,953.023 1254.05,917.562 1256.4,987.688 1258.75,997.757 1261.1,976.864 1263.45,862.164 1265.8,1046.1 1268.15,961.864 1270.5,1118.88 1272.85,943.222 1275.2,822.969 1277.55,773.766 1279.9,1044.77 1282.25,968.656 1284.6,794.511 1286.95,886.59 1289.3,996.023 1291.66,775.878 1294.01,857.84 1296.36,908.134 1298.71,905.595 1301.06,878.979 1303.41,784.787 1305.76,1006.88 1308.11,697.865 1310.46,722.82 1312.81,945.176 1315.16,1060.29 1317.51,1027.46 1319.86,948.808 1322.21,919.344 1324.56,902.103 1326.91,724.819 1329.26,1054.5 1331.61,1091.3 1333.96,1117.92 1336.31,919.23 1338.66,1014.13 1341.02,907.112 1343.37,855.161 1345.72,936.398 1348.07,1038.6 1350.42,851.53 1352.77,1035.03 1355.12,868.772 1357.47,976.322 1359.82,893.489 1362.17,926.208 1364.52,885.149 1366.87,962.673 1369.22,749.721 1371.57,831.875 1373.92,1035.59 1376.27,936.039 1378.62,996.49 1380.97,813.72 1383.32,739.901 1385.67,969.385 1388.02,832.584 1390.38,1055.55 1392.73,833.799 1395.08,903.789 1397.43,909.052 1399.78,900.271 1402.13,793.307 1404.48,853.497 1406.83,892.603 1409.18,818.138 1411.53,938.867 1413.88,944.108 1416.23,796.039 1418.58,900.056 1420.93,918.391 1423.28,894.854 1425.63,1037.94 1427.98,859.09 1430.33,865.102 1432.68,746.333 1435.03,784.291 1437.38,756.896 1439.74,796.254 1442.09,765.77 1444.44,852.722 1446.79,907.843 1449.14,774.131 1451.49,967.498 1453.84,1035.59 1456.19,797.11 1458.54,1050.64 1460.89,972.237 1463.24,940.288 1465.59,897.341 1467.94,1003.9 1470.29,916.589 1472.64,1049.01 1474.99,990.781 1477.34,889.39 1479.69,940.613 1482.04,1103.15 1484.39,818.018 1486.74,1055.18 1489.1,942.996 1491.45,901.752 1493.8,979.199 1496.15,884.449 1498.5,1075.79 1500.85,888.932 1503.2,915.131 1505.55,787.286 1507.9,779.742 1510.25,940.026 1512.6,821.248 1514.95,924.681 1517.3,1057.22 1519.65,890.723 1522,911.687 1524.35,974.14 1526.7,996.26 1529.05,934.053 1531.4,920.153 1533.75,957.24 1536.1,907.718 1538.45,838.701 1540.81,980.016 1543.16,880.893 1545.51,1017.8 1547.86,880.817 1550.21,805.095 1552.56,870.516 1554.91,827.604 1557.26,1020.76 1559.61,1089.21 1561.96,1011.34 1564.31,912.324 1566.66,904.606 1569.01,1128.48 1571.36,821.702 1573.71,1048.22 1576.06,945.564 1578.41,888.17 1580.76,1011.82 1583.11,834.912 1585.46,831.255 1587.81,748.027 1590.17,788.842 1592.52,998.905 1594.87,947.679 1597.22,942.651 1599.57,796.18 1601.92,996.031 1604.27,876.112 1606.62,920.66 1608.97,802.375 1611.32,981.908 1613.67,920.068 1616.02,977.392 1618.37,1060.75 1620.72,992.704 1623.07,1013.94 1625.42,768.334 1627.77,997.435 1630.12,901.295 1632.47,937.747 1634.82,949.758 1637.17,1236.01 1639.53,846.11 1641.88,841.2 1644.23,1123.61 1646.58,1047.92 1648.93,781.338 1651.28,845.073 1653.63,823.15 1655.98,935.443 1658.33,830.361 1660.68,952.708 1663.03,855.991 1665.38,1065.48 1667.73,826.426 1670.08,1032.13 1672.43,1053.11 1674.78,940.11 1677.13,744.774 1679.48,915.894 1681.83,1065.63 1684.18,1127.22 1686.53,851.906 1688.89,967.974 1691.24,958.968 1693.59,833.602 1695.94,775.894 1698.29,816.615 1700.64,799.44 1702.99,996.675 1705.34,913.559 1707.69,868.142 1710.04,893.588 1712.39,906.685 1714.74,818.83 1717.09,1156.16 1719.44,833.926 1721.79,1021 1724.14,897.973 1726.49,877.989 1728.84,1017.15 1731.19,803.618 1733.54,839.34 1735.89,991.82 1738.25,1009.03 1740.6,929.54 1742.95,990.783 1745.3,1039.9 1747.65,797.902 1750,806.496 1752.35,789.874 1754.7,844.932 1757.05,911.641 1759.4,1044.93 1761.75,796.853 1764.1,1005.19 1766.45,1029.32 1768.8,679.83 1771.15,785.958 1773.5,933.825 1775.85,1020.16 1778.2,1034.36 1780.55,936.788 1782.9,932.438 1785.25,847.707 1787.6,1031.33 1789.96,1083.88 1792.31,893.117 1794.66,905.308 1797.01,878.839 1799.36,883.098 1801.71,1011.66 1804.06,841.677 1806.41,903.076 1808.76,863.209 1811.11,911.596 1813.46,886.59 1815.81,1073.82 1818.16,810.651 1820.51,930.335 1822.86,828.471 1825.21,871.971 1827.56,836.931 1829.91,794.594 1832.26,865.892 1834.61,897.357 1836.96,1032.3 1839.32,799.645 1841.67,886.429 1844.02,804.384 1846.37,880.328 1848.72,997.393 1851.07,956.487 1853.42,774.416 1855.77,904.825 1858.12,866.905 1860.47,742.497 1862.82,952.818 1865.17,805.707 1867.52,1019.26 1869.87,854.885 1872.22,1059.54 1874.57,949.658 1876.92,904.615 1879.27,854.331 1881.62,986.162 1883.97,1110.27 1886.32,913.267 1888.68,911.85 1891.03,895.571 1893.38,815.597 1895.73,890.582 1898.08,852.308 1900.43,920.795 1902.78,864.278 1905.13,684.77 1907.48,886.044 1909.83,749.326 1912.18,933.61 1914.53,915.375 1916.88,1017.13 1919.23,902.239 1921.58,969.385 1923.93,940.781 1926.28,878.549 1928.63,917.507 1930.98,1089.43 1933.33,1021.81 1935.68,1004.66 1938.04,819.721 1940.39,803.506 1942.74,985.67 1945.09,864.172 1947.44,888.794 1949.79,923.85 1952.14,840.261 1954.49,943.517 1956.84,1040.53 1959.19,965.413 1961.54,817.688 1963.89,967.805 1966.24,913.692 1968.59,907.543 1970.94,833.176 1973.29,752.269 1975.64,833.528 1977.99,808.993 1980.34,958.001 1982.69,887.148 1985.04,1079.99 1987.4,750.673 1989.75,785.583 1992.1,919.461 1994.45,923.815 1996.8,856.801 1999.15,1021.41 2001.5,867.415 2003.85,982.672 2006.2,857.82 2008.55,920.717 2010.9,939.937 2013.25,901.135 2015.6,1008.33 2017.95,1023.85 2020.3,805.981 2022.65,705.906 2025,890.076 2027.35,751.051 2029.7,885.804 2032.05,880.436 2034.4,1041.31 2036.76,947.542 2039.11,857.806 2041.46,1013.48 2043.81,930.984 2046.16,1152.4 2048.51,940.488 2050.86,914.443 2053.21,1047.43 2055.56,957.47 2057.91,1127.63 2060.26,762.162 2062.61,966.329 2064.96,832.322 2067.31,977.92 2069.66,960.664 2072.01,989.31 2074.36,904.904 2076.71,872.839 2079.06,802.377 2081.41,941.366 2083.76,653.908 2086.11,1073.1 2088.47,1043.74 2090.82,833.294 2093.17,755.251 2095.52,1080.14 2097.87,1067 2100.22,1018.66 2102.57,1133.03 2104.92,906.205 2107.27,1072.3 2109.62,914.89 2111.97,809.26 2114.32,795.55 2116.67,771.754 2119.02,880.713 2121.37,956.192 2123.72,992.177 2126.07,885.436 2128.42,862.203 2130.77,1042.19 2133.12,893.724 2135.47,967.271 2137.83,902.58 2140.18,901.231 2142.53,922.208 2144.88,912.633 2147.23,830.396 2149.58,709.703 2151.93,1017.57 2154.28,895.71 2156.63,915.627 2158.98,777.492 2161.33,920.955 2163.68,751.723 2166.03,937.718 2168.38,975.592 2170.73,971.324 2173.08,776.208 2175.43,766.794 2177.78,907.864 2180.13,860.827 2182.48,936.42 2184.83,925.252 2187.19,1013.6 2189.54,904.736 2191.89,754.536 2194.24,898.753 2196.59,966.955 2198.94,858.006 2201.29,1000.59 2203.64,887.385 2205.99,1049.08 2208.34,861.844 2210.69,869.692 2213.04,1019.14 2215.39,987.537 2217.74,735.608 2220.09,859.181 2222.44,996.076 2224.79,842.748 2227.14,780.862 2229.49,920.062 2231.84,920.88 2234.19,997.817 2236.55,902.711 2238.9,992.888 2241.25,838.077 2243.6,726.491 2245.95,730.078 2248.3,869.009 2250.65,720.614 2253,1045 2255.35,1036.96 2257.7,818.576 2260.05,989.863 2262.4,959.333 2264.75,1123.72 2267.1,942.416 2269.45,928.764 2271.8,957.198 2274.15,906.213 2276.5,898.55 2278.85,858.24 2281.2,909.036 2283.55,966.86 2285.91,947.507 2288.26,1148.36 2290.61,930.537 2292.96,1109.22 2295.31,1158.09 2297.66,942.737 2300.01,866.998 2302.36,944.319 2304.71,910.059 2307.06,909.078 2309.41,869.93 2311.76,996.193 2314.11,875.218 2316.46,752.862 2318.81,793.63 2321.16,963.633 2323.51,858.76 2325.86,884.013 2328.21,899.18 2330.56,923.112 2332.91,885.609 2335.27,892.757 2337.62,933.005 2339.97,937.656 2342.32,1030.97 2344.67,936.478 2347.02,729.776 2349.37,1108.22 2351.72,822.841 2354.07,1004 2356.42,1012.37 2358.77,1017.95 2361.12,921.2 2363.47,945.818 2365.82,847.299 2368.17,934.608 2370.52,997.209 2372.87,1005.99 2375.22,876.737 2377.57,922.952 2379.92,920.23 2382.27,928.29 2384.62,867.25 2386.98,921.662 2389.33,819.91 2391.68,997.564 2394.03,916.182 2396.38,801.108 2398.73,901.964 2401.08,716.77 2403.43,944.508 2405.78,1188.98 2408.13,1014.8 2410.48,978.586 2412.83,1018.62 2415.18,761.46 2417.53,826.887 2419.88,1070.14 2422.23,918.298 2424.58,925.553 2426.93,1002.06 2429.28,916.945 2431.63,1012.84 2433.98,1067.58 2436.34,897.628 2438.69,874.121 2441.04,714.36 2443.39,999.626 2445.74,780.433 2448.09,867.324 2450.44,819.177 2452.79,940.401 2455.14,1021.26 2457.49,917.321 2459.84,928.925 2462.19,793.566 2464.54,977.357 2466.89,805.936 2469.24,969.053 2471.59,933.593 2473.94,1039.02 2476.29,793.224 2478.64,820.785 2480.99,815.826 2483.34,999.676 2485.7,883.971 2488.05,876.541 2490.4,836.394 2492.75,917.088 2495.1,1030.89 2497.45,765.656 2499.8,937.084 2502.15,890.098 2504.5,788.603 2506.85,698.479 2509.2,871.949 2511.55,868.622 2513.9,971.688 2516.25,921.313 2518.6,643.619 2520.95,897.546 2523.3,869.044 2525.65,1149.41 2528,805.392 2530.35,913.995 2532.7,675.955 2535.06,905.523 2537.41,811.948 2539.76,903.269 2542.11,992.922 2544.46,1026.43 2546.81,1076.7 2549.16,813.283 2551.51,966.193 2553.86,880.937 2556.21,894.298 2558.56,1004.4 2560.91,994.016 2563.26,857.196 2565.61,802.338 2567.96,995.133 2570.31,909.083 "></polyline>
<polyline clip-path="url(#clip172)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,560.062 224.541,453.481 226.891,458.993 229.242,389.415 231.592,513.836 233.943,504.408 236.293,459.281 238.644,617.872 240.994,520.822 243.345,311.101 245.695,283.927 248.046,381.34 250.396,477.626 252.747,426.644 255.097,520.183 257.448,330.125 259.798,457.348 262.148,242.142 264.499,381.661 266.849,370.402 269.2,407.687 271.55,581.24 273.901,445.882 276.251,537.621 278.602,305.433 280.952,389.625 283.303,500.316 285.653,397.173 288.004,482.47 290.354,357.792 292.705,485.328 295.055,515.962 297.406,361.888 299.756,282.624 302.107,497.354 304.457,390.121 306.807,544.385 309.158,447.938 311.508,419.348 313.859,289.769 316.209,507.605 318.56,537.056 320.91,424.724 323.261,358.713 325.611,360.362 327.962,498.672 330.312,365.621 332.663,307.609 335.013,288.33 337.364,303.583 339.714,420.87 342.065,716.68 344.415,592.089 346.765,453.55 349.116,405.5 351.466,531.609 353.817,393.552 356.167,370.911 358.518,303.168 360.868,364.107 363.219,373.759 365.569,422.383 367.92,591.9 370.27,436.783 372.621,373.787 374.971,500.62 377.322,373.024 379.672,540.69 382.023,374.527 384.373,532.998 386.724,340.325 389.074,387.453 391.424,324.526 393.775,160.013 396.125,438.934 398.476,395.539 400.826,435.168 403.177,638.732 405.527,479.236 407.878,389.226 410.228,376.134 412.579,296.615 414.929,542.884 417.28,379.208 419.63,308.586 421.981,394.218 424.331,346.448 426.682,307.187 429.032,684.459 431.382,367.788 433.733,466.495 436.083,420.639 438.434,293.317 440.784,324.45 443.135,440.046 445.485,566.835 447.836,487.96 450.186,457.733 452.537,542.61 454.887,400.091 457.238,362.748 459.588,363.82 461.939,407.926 464.289,385.958 466.64,533.228 468.99,510.247 471.341,422.689 473.691,464.587 476.041,434.17 478.392,312.917 480.742,562.409 483.093,291.646 485.443,787.539 487.794,441.254 490.144,465.391 492.495,435.501 494.845,435.766 497.196,229.659 499.546,316.153 501.897,382.864 504.247,402.238 506.598,322.816 508.948,341.802 511.299,417.815 513.649,400.222 515.999,279.799 518.35,378.204 520.7,257.381 523.051,345.188 525.401,545.056 527.752,276.822 530.102,480.431 532.453,347.39 534.803,446.386 537.154,326.129 539.504,485.646 541.855,590.892 544.205,488.254 546.556,399.858 548.906,538.235 551.257,351.809 553.607,435.058 555.958,471.612 558.308,583.251 560.658,278.109 563.009,295.325 565.359,565.768 567.71,190.292 570.06,521.565 572.411,467.37 574.761,333.505 577.112,328.937 579.462,379.888 581.813,493.472 584.163,362.802 586.514,377.599 588.864,459.561 591.215,572.444 593.565,414.956 595.916,384.826 598.266,489.834 600.616,493.584 602.967,398.28 605.317,521.059 607.668,412.247 610.018,543.291 612.369,355.621 614.719,553.376 617.07,348.05 619.42,578.634 621.771,302.983 624.121,512.646 626.472,349.482 628.822,466.809 631.173,535.889 633.523,447.219 635.874,407.254 638.224,308.298 640.575,330.966 642.925,403.917 645.275,417.319 647.626,271.564 649.976,395.026 652.327,480.681 654.677,363.51 657.028,558.426 659.378,396.689 661.729,358.881 664.079,251.138 666.43,311.842 668.78,470.289 671.131,418.326 673.481,508.033 675.832,374.307 678.182,503.836 680.533,380.1 682.883,420.354 685.233,371.289 687.584,490.954 689.934,500.472 692.285,561.829 694.635,553.964 696.986,340.782 699.336,315.237 701.687,200.275 704.037,446.746 706.388,474.696 708.738,301.224 711.089,356.288 713.439,110.007 715.79,344.624 718.14,318.197 720.491,416.309 722.841,396.749 725.192,416.387 727.542,276.077 729.892,228.841 732.243,287.36 734.593,566.724 736.944,379.674 739.294,181.246 741.645,250.786 743.995,472.556 746.346,300.829 748.696,402.006 751.047,318.832 753.397,336.021 755.748,338.921 758.098,361.569 760.449,354.72 762.799,315.898 765.15,335.061 767.5,571.188 769.85,378.074 772.201,608.04 774.551,522.288 776.902,264.023 779.252,454.362 781.603,310.35 783.953,456.658 786.304,343.982 788.654,523.611 791.005,437.279 793.355,506.608 795.706,458.877 798.056,520.805 800.407,455.818 802.757,382.552 805.108,374.452 807.458,293.084 809.809,298.25 812.159,271.137 814.509,455.617 816.86,332.252 819.21,302.358 821.561,402.411 823.911,349.494 826.262,552.66 828.612,515.071 830.963,415.349 833.313,236.642 835.664,303.726 838.014,385.391 840.365,516.346 842.715,484.698 845.066,429.616 847.416,370.827 849.767,493.926 852.117,252.103 854.467,392.913 856.818,434.939 859.168,268.114 861.519,383.012 863.869,534.07 866.22,421.619 868.57,512.171 870.921,569.697 873.271,420.667 875.622,404.801 877.972,387.031 880.323,505.826 882.673,411.954 885.024,285.251 887.374,332.215 889.725,469.692 892.075,225.745 894.426,252.047 896.776,371.513 899.126,288.089 901.477,514.195 903.827,598.16 906.178,431.568 908.528,368.586 910.879,432.075 913.229,518.529 915.58,417.44 917.93,367.317 920.281,484.451 922.631,453.638 924.982,418.32 927.332,472.612 929.683,377.083 932.033,434.469 934.384,396.136 936.734,306.752 939.084,365.848 941.435,441.96 943.785,225.884 946.136,508.416 948.486,284.257 950.837,510.427 953.187,444.333 955.538,495.118 957.888,282.552 960.239,306.985 962.589,379.848 964.94,510.6 967.29,486.021 969.641,420.278 971.991,390.407 974.342,426.198 976.692,627.048 979.043,521.26 981.393,463.427 983.743,466.084 986.094,593.331 988.444,395.313 990.795,565.729 993.145,415.93 995.496,278.785 997.846,454.489 1000.2,399.189 1002.55,425.444 1004.9,420.55 1007.25,519.348 1009.6,456.606 1011.95,352.136 1014.3,562.713 1016.65,351.577 1019,351.487 1021.35,345.763 1023.7,488.387 1026.05,425.121 1028.4,530.555 1030.75,530.714 1033.1,626.82 1035.45,410.334 1037.8,401.6 1040.15,388.681 1042.51,482.166 1044.86,359.645 1047.21,457.602 1049.56,462.569 1051.91,477.443 1054.26,407.466 1056.61,554.867 1058.96,499.602 1061.31,387.344 1063.66,405.672 1066.01,351.947 1068.36,346.353 1070.71,432.241 1073.06,611.434 1075.41,101.04 1077.76,495.757 1080.11,301.217 1082.46,595.896 1084.81,449.614 1087.16,431.791 1089.51,478.726 1091.87,264.042 1094.22,352.661 1096.57,579.261 1098.92,514.012 1101.27,492.567 1103.62,288.427 1105.97,382.456 1108.32,509.707 1110.67,454.395 1113.02,453.732 1115.37,355.576 1117.72,566.58 1120.07,566.613 1122.42,472.89 1124.77,504.841 1127.12,488.626 1129.47,497.69 1131.82,507.032 1134.17,390.429 1136.52,410.238 1138.87,405.787 1141.23,406.667 1143.58,509.891 1145.93,315.795 1148.28,530.733 1150.63,373.7 1152.98,247.883 1155.33,565.867 1157.68,400.221 1160.03,288.438 1162.38,403.562 1164.73,441.89 1167.08,476.095 1169.43,352.892 1171.78,392.297 1174.13,427.155 1176.48,496.831 1178.83,405.817 1181.18,505.839 1183.53,340.63 1185.88,256.227 1188.23,538.655 1190.59,369.844 1192.94,463.694 1195.29,603.284 1197.64,328.28 1199.99,449.878 1202.34,333.702 1204.69,531.654 1207.04,348.067 1209.39,322.116 1211.74,575.977 1214.09,566.572 1216.44,413.361 1218.79,476.156 1221.14,430.892 1223.49,306.916 1225.84,343.887 1228.19,546.821 1230.54,358.337 1232.89,340.393 1235.24,497.488 1237.59,397.669 1239.94,474.164 1242.3,376.9 1244.65,507.173 1247,382.78 1249.35,275.485 1251.7,513.24 1254.05,375.186 1256.4,453.206 1258.75,375.119 1261.1,394.73 1263.45,447.654 1265.8,472.987 1268.15,340.69 1270.5,471.726 1272.85,623.388 1275.2,311.034 1277.55,445.763 1279.9,356.762 1282.25,467.035 1284.6,429.777 1286.95,563.447 1289.3,574.737 1291.66,474.64 1294.01,385.951 1296.36,236.395 1298.71,467.919 1301.06,453.383 1303.41,395.208 1305.76,296.851 1308.11,330.349 1310.46,400.057 1312.81,395.163 1315.16,401.291 1317.51,489.358 1319.86,477.617 1322.21,556.979 1324.56,317.265 1326.91,416.542 1329.26,378.593 1331.61,426.23 1333.96,495.412 1336.31,307.968 1338.66,234.99 1341.02,353.423 1343.37,626.98 1345.72,362.336 1348.07,392.556 1350.42,402.388 1352.77,441.583 1355.12,487.605 1357.47,646.407 1359.82,540.393 1362.17,441.954 1364.52,373.119 1366.87,481.117 1369.22,232.828 1371.57,206.744 1373.92,252.456 1376.27,572.358 1378.62,471.763 1380.97,461.93 1383.32,215.426 1385.67,497.919 1388.02,433.179 1390.38,357.01 1392.73,603.37 1395.08,331.423 1397.43,551.425 1399.78,425.319 1402.13,397.174 1404.48,483.667 1406.83,332.016 1409.18,383.066 1411.53,633.199 1413.88,583.263 1416.23,122.799 1418.58,339.512 1420.93,374.815 1423.28,254.528 1425.63,439.078 1427.98,459.148 1430.33,228.059 1432.68,296.354 1435.03,474.396 1437.38,429.587 1439.74,522.79 1442.09,388.387 1444.44,593.187 1446.79,615.953 1449.14,475.386 1451.49,423.499 1453.84,502.395 1456.19,369.963 1458.54,413.063 1460.89,493.543 1463.24,528.206 1465.59,252.912 1467.94,468.173 1470.29,331.601 1472.64,336.44 1474.99,341.971 1477.34,580.622 1479.69,520.262 1482.04,496.44 1484.39,296.251 1486.74,472.85 1489.1,422.38 1491.45,367.208 1493.8,355.907 1496.15,453.286 1498.5,370.995 1500.85,355.27 1503.2,332.83 1505.55,299.726 1507.9,208.097 1510.25,419.861 1512.6,476.621 1514.95,394.477 1517.3,474.175 1519.65,475.707 1522,432.973 1524.35,545.101 1526.7,284.248 1529.05,327.072 1531.4,420.702 1533.75,446.19 1536.1,383.917 1538.45,457.983 1540.81,205.913 1543.16,475.48 1545.51,410.326 1547.86,506.596 1550.21,553.927 1552.56,288.018 1554.91,507.08 1557.26,741.091 1559.61,469.317 1561.96,381.658 1564.31,368.779 1566.66,461.744 1569.01,465.757 1571.36,175.817 1573.71,416.024 1576.06,464.405 1578.41,477.414 1580.76,496.808 1583.11,464.152 1585.46,431.825 1587.81,503.526 1590.17,473.975 1592.52,438.508 1594.87,462.652 1597.22,425.846 1599.57,524.167 1601.92,588.903 1604.27,266.985 1606.62,469.446 1608.97,414.923 1611.32,342.985 1613.67,447.723 1616.02,201.663 1618.37,322.7 1620.72,415.775 1623.07,333.472 1625.42,591.855 1627.77,309.107 1630.12,417.576 1632.47,261.417 1634.82,453.997 1637.17,454.955 1639.53,475.829 1641.88,255.576 1644.23,408.241 1646.58,207.921 1648.93,503.781 1651.28,369.264 1653.63,536.287 1655.98,392.86 1658.33,602.015 1660.68,491.828 1663.03,492.198 1665.38,250.134 1667.73,548.914 1670.08,430.273 1672.43,306.426 1674.78,412.795 1677.13,402.43 1679.48,272.046 1681.83,349.173 1684.18,416.746 1686.53,422.692 1688.89,320.343 1691.24,392.177 1693.59,339.674 1695.94,466.189 1698.29,415.057 1700.64,488.897 1702.99,529.049 1705.34,242.268 1707.69,262.78 1710.04,367.28 1712.39,424.214 1714.74,436.583 1717.09,512.113 1719.44,545.739 1721.79,413.001 1724.14,354.455 1726.49,290.658 1728.84,457.333 1731.19,401.121 1733.54,340.199 1735.89,488.267 1738.25,575.995 1740.6,395.928 1742.95,336.843 1745.3,429.045 1747.65,633.96 1750,446.061 1752.35,392.069 1754.7,550.282 1757.05,419.504 1759.4,302.894 1761.75,178.091 1764.1,446.806 1766.45,529.836 1768.8,490.525 1771.15,617.131 1773.5,673.439 1775.85,413.526 1778.2,561.318 1780.55,326.64 1782.9,342.211 1785.25,352.065 1787.6,268.255 1789.96,477.113 1792.31,285.414 1794.66,440.546 1797.01,394.364 1799.36,280.227 1801.71,447.003 1804.06,520.919 1806.41,439.501 1808.76,442.868 1811.11,457.066 1813.46,471.35 1815.81,508.555 1818.16,418.098 1820.51,493.729 1822.86,433.68 1825.21,438.119 1827.56,511.529 1829.91,336.242 1832.26,283.217 1834.61,468.763 1836.96,352.759 1839.32,311.011 1841.67,464.969 1844.02,317.385 1846.37,360.329 1848.72,327.031 1851.07,485.649 1853.42,527.593 1855.77,314.833 1858.12,315.629 1860.47,347.73 1862.82,506.529 1865.17,655.959 1867.52,299.393 1869.87,423.853 1872.22,334.918 1874.57,472.209 1876.92,300.834 1879.27,340.526 1881.62,224.385 1883.97,430.35 1886.32,470.311 1888.68,295.819 1891.03,368.263 1893.38,254.375 1895.73,501.864 1898.08,473.311 1900.43,367.016 1902.78,368.326 1905.13,475.056 1907.48,397.368 1909.83,450.672 1912.18,342.753 1914.53,333.537 1916.88,510.527 1919.23,507.341 1921.58,401.965 1923.93,413.091 1926.28,289.742 1928.63,469.023 1930.98,544.955 1933.33,384.737 1935.68,448.852 1938.04,325.292 1940.39,634.147 1942.74,390.141 1945.09,364.484 1947.44,396.462 1949.79,494.933 1952.14,386.896 1954.49,300.916 1956.84,449.146 1959.19,358.821 1961.54,227.691 1963.89,535.181 1966.24,419.627 1968.59,523.836 1970.94,473.487 1973.29,544.351 1975.64,412.645 1977.99,468.664 1980.34,380.44 1982.69,374.345 1985.04,406.975 1987.4,428.599 1989.75,417.668 1992.1,395.898 1994.45,161.912 1996.8,375.89 1999.15,318.749 2001.5,474.724 2003.85,254.829 2006.2,377.191 2008.55,524.133 2010.9,315.848 2013.25,573.07 2015.6,507.921 2017.95,631.566 2020.3,372.916 2022.65,385.743 2025,488.213 2027.35,316.639 2029.7,393.436 2032.05,337.917 2034.4,420.376 2036.76,433.352 2039.11,202.8 2041.46,514.995 2043.81,527.666 2046.16,286.231 2048.51,389.285 2050.86,334.818 2053.21,345.676 2055.56,366.125 2057.91,537.586 2060.26,517.171 2062.61,279.189 2064.96,236.239 2067.31,425.949 2069.66,317.371 2072.01,336.974 2074.36,555.126 2076.71,445.188 2079.06,260.975 2081.41,587.467 2083.76,315.933 2086.11,437.392 2088.47,538.401 2090.82,409.831 2093.17,399.06 2095.52,522.118 2097.87,458.492 2100.22,570.481 2102.57,344.203 2104.92,277.591 2107.27,344.563 2109.62,545.401 2111.97,269.114 2114.32,265.781 2116.67,530.512 2119.02,287.529 2121.37,518.985 2123.72,436.562 2126.07,470.158 2128.42,522.606 2130.77,383.915 2133.12,573.188 2135.47,389.946 2137.83,444.429 2140.18,547.436 2142.53,445.618 2144.88,265.114 2147.23,381.377 2149.58,385.664 2151.93,411.605 2154.28,571.946 2156.63,327.72 2158.98,272.866 2161.33,528.884 2163.68,403.299 2166.03,427.357 2168.38,483.049 2170.73,557.309 2173.08,539.789 2175.43,422.91 2177.78,282.224 2180.13,416.087 2182.48,421.084 2184.83,607.534 2187.19,459.298 2189.54,248.222 2191.89,423.282 2194.24,199.453 2196.59,139.667 2198.94,375.96 2201.29,543.876 2203.64,245.733 2205.99,310.375 2208.34,288.323 2210.69,602.179 2213.04,558.345 2215.39,549.873 2217.74,326.306 2220.09,320.821 2222.44,505.497 2224.79,211.961 2227.14,422.511 2229.49,279.51 2231.84,309.134 2234.19,396.839 2236.55,536.245 2238.9,554.599 2241.25,338.147 2243.6,408.3 2245.95,328.461 2248.3,432.371 2250.65,470.969 2253,445.652 2255.35,427.767 2257.7,284.36 2260.05,396.914 2262.4,456.856 2264.75,498.189 2267.1,426.104 2269.45,349.09 2271.8,339.169 2274.15,390.811 2276.5,346.159 2278.85,441.642 2281.2,340.425 2283.55,431.704 2285.91,111.9 2288.26,96.8724 2290.61,398.913 2292.96,517.169 2295.31,413.895 2297.66,498.216 2300.01,435.777 2302.36,345.839 2304.71,343.597 2307.06,443.541 2309.41,318.864 2311.76,406.608 2314.11,395.753 2316.46,493.641 2318.81,516.92 2321.16,491.613 2323.51,280.255 2325.86,323.825 2328.21,433.38 2330.56,530.596 2332.91,401.024 2335.27,495.504 2337.62,389.922 2339.97,418.282 2342.32,308.812 2344.67,370.262 2347.02,489.232 2349.37,352.519 2351.72,477.646 2354.07,477.394 2356.42,288.029 2358.77,413.427 2361.12,534.684 2363.47,613.985 2365.82,260.414 2368.17,355.717 2370.52,495.895 2372.87,520.605 2375.22,470.121 2377.57,506.907 2379.92,413.797 2382.27,383.032 2384.62,624.01 2386.98,377.326 2389.33,478.97 2391.68,398.256 2394.03,463.107 2396.38,327.64 2398.73,477.944 2401.08,426.589 2403.43,240.056 2405.78,309.856 2408.13,404.006 2410.48,507.204 2412.83,522.308 2415.18,351.297 2417.53,457.252 2419.88,166.688 2422.23,387.618 2424.58,529.032 2426.93,497.684 2429.28,551.493 2431.63,263.079 2433.98,352.301 2436.34,199.723 2438.69,554.312 2441.04,473.406 2443.39,387.287 2445.74,522.367 2448.09,434.343 2450.44,338.44 2452.79,302.18 2455.14,295.835 2457.49,450.858 2459.84,472.438 2462.19,427.229 2464.54,525.42 2466.89,455.215 2469.24,349.323 2471.59,457.62 2473.94,346.998 2476.29,290.627 2478.64,408.353 2480.99,479.61 2483.34,530.757 2485.7,551.872 2488.05,437.886 2490.4,381.828 2492.75,331.581 2495.1,372.744 2497.45,565.893 2499.8,348.062 2502.15,345.181 2504.5,360.974 2506.85,635.192 2509.2,453.797 2511.55,509.585 2513.9,433.659 2516.25,509.249 2518.6,739.188 2520.95,333.541 2523.3,374.079 2525.65,347.032 2528,417.24 2530.35,361.284 2532.7,472.626 2535.06,485.695 2537.41,518.927 2539.76,654.339 2542.11,332.834 2544.46,392.486 2546.81,424.501 2549.16,260.069 2551.51,274.632 2553.86,498.328 2556.21,306.288 2558.56,403.462 2560.91,381.13 2563.26,211.256 2565.61,413.28 2567.96,448.47 2570.31,529.077 "></polyline>
</svg>
</div>
</div>
<p>Look at that! Things are working; amazin’.</p>
<p>We can also exploit <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a>’s parallel sampling capabilities:</p>
<div id="34" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run separate 4 chains for 10 000 iterations using threads to parallelize.</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>num_chains <span class="op">=</span> <span class="fl">4</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    model_with_grad,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    sampler,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">MCMCThreads</span>(),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="fl">10_000</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    num_chains;</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note we need to provide an initial state for every chain.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    initial_state<span class="op">=</span><span class="fu">fill</span>(state, num_chains),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">=</span><span class="cn">false</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>samples_array <span class="op">=</span> <span class="fu">stack</span>(<span class="fu">map</span>(<span class="bu">Base</span>.<span class="fu">Fix1</span>(stack, sample <span class="op">-&gt;</span> sample.x), samples))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×10000×4 Array{Float64, 3}:
[:, :, 1] =
 -2.00406   -2.22034  -2.89943   -3.60242   …  -5.32494   -5.88802  -4.15294
 -0.339297  -2.63232   0.594403   0.657375      0.792896   1.62569   2.53184
  4.97328    4.48965   7.39602    4.60795       6.27714    6.42549   7.11679

[:, :, 2] =
 -1.89782  -2.52334   -2.95407  -4.05516  …  -5.75055   -5.67599   -5.67599
  1.02797   0.800848  -0.94584   1.23418      0.691245   0.729154   0.729154
  2.67078   3.99008    5.15208   5.4576       5.59309    4.90673    4.90673

[:, :, 3] =
 -3.52681   -5.93193  -4.50768   -4.47001  …  -4.88324   -4.88324   -5.22664
 -0.351221  -0.30995  -0.961492  -1.18344      0.699369   0.699369   1.00225
  2.31813    4.55118   4.71278    4.92016      5.63958    5.63958    4.24117

[:, :, 4] =
 -1.06082   -1.72584  -4.31832  …  -6.37711   -6.70628   -4.79631
 -0.340474  -1.16736  -1.14724      0.608609  -0.363223  -1.94823
  1.832      3.4033    3.74977      3.99055    5.01542    3.566</code></pre>
</div>
</div>
<p>But the fact that we have to provide the <code>AbstractMCMC.sample</code> call, etc. with an <code>initial_state</code> to get started is a bit annoying. We can avoid this by also defining a <code>AbstractMCMC.step</code> <em>without</em> the <code>state</code> argument:</p>
<div id="36" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    model_wrapper<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span><span class="dt">MALA</span>;</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: No state provided!</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_wrapper.logdensity</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's just create the initial state by sampling using  a Gaussian.</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">randn</span>(rng, LogDensityProblems.<span class="fu">dimension</span>(model))</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">MALASample</span>(x), <span class="fu">MALAState</span>(x)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Equipped with this, we no longer need to provide the <code>initial_state</code> everywhere:</p>
<div id="38" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(model_with_grad, sampler, <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>samples_matrix <span class="op">=</span> <span class="fu">stack</span>(sample <span class="op">-&gt;</span> sample.x, samples)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hcat</span>(<span class="fu">mean</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>), <span class="fu">std</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×2 Matrix{Float64}:
 -4.96722    1.00257
  0.0285031  1.00485
  4.9906     0.997022</code></pre>
</div>
</div>
</section>
<section id="using-our-sampler-with-turing.jl" class="level2">
<h2 class="anchored" data-anchor-id="using-our-sampler-with-turing.jl">Using our sampler with Turing.jl</h2>
<p>As we promised, all of this hassle of implementing our <code>MALA</code> sampler in a way that uses <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> and <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> gets us something more than <em>just</em> an “automatic” implementation of <code>AbstractMCMC.sample</code>.</p>
<p>It also enables use with Turing.jl through the <code>externalsampler</code>, but we need to do one final thing first: we need to tell Turing.jl how to extract a vector of parameters from the “sample” returned in our implementation of <code>AbstractMCMC.step</code>. In our case, the “sample” is a <code>MALASample</code>, so we just need the following line:</p>
<div id="40" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Turing.jl.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Turing</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Overload the `getparams` method for our "sample" type, which is just a vector.</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>Turing.Inference.<span class="fu">getparams</span>(<span class="op">::</span><span class="dt">Turing.Model</span>, sample<span class="op">::</span><span class="dt">MALASample</span>) <span class="op">=</span> sample.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And with that, we’re good to go!</p>
<div id="42" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Our previous model defined as a Turing.jl model.</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="fu">mvnormal_model</span>() <span class="op">=</span> x <span class="op">~</span> <span class="fu">MvNormal</span>([<span class="op">-</span><span class="fl">5</span>., <span class="fl">0</span>., <span class="fl">5</span>.], I)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate our model.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>turing_model <span class="op">=</span> <span class="fu">mvnormal_model</span>()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Call `sample` but now we're passing in a Turing.jl `model` and wrapping</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># our `MALA` sampler in the `externalsampler` to tell Turing.jl that the sampler</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># expects something that implements LogDensityProblems.jl.</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×4×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 2.87 seconds
Compute duration  = 2.87 seconds
parameters        = x[1], x[2], x[3]
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold">  ess_bulk </span> <span class="ansi-bold">  ess_tail </span> <span class="ansi-bold">    rhat </span>  ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>  ⋯

        x[1]   -5.0090    1.0065    0.0175   3294.9434   4941.9012    1.0001   ⋯
        x[2]    0.0262    1.0045    0.0177   3222.1408   5172.0471    1.0006   ⋯
        x[3]    4.9982    0.9888    0.0167   3492.7741   5646.3644    1.0009   ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

        x[1]   -6.9865   -5.6760   -5.0167   -4.3435   -3.0183
        x[2]   -1.9330   -0.6599    0.0097    0.7133    1.9988
        x[3]    3.0726    4.3267    4.9999    5.6763    6.9405
</pre>
</div>
</div>
</div>
<p>Pretty neat, eh?</p>
<section id="models-with-constrained-parameters" class="level3">
<h3 class="anchored" data-anchor-id="models-with-constrained-parameters">Models with constrained parameters</h3>
<p>One thing we’ve sort of glossed over in all of the above is that MALA, at least how we’ve implemented it, requires <span class="math inline">\(x\)</span> to live in <span class="math inline">\(\mathbb{R}^d\)</span> for some <span class="math inline">\(d &gt; 0\)</span>. If some of the parameters were in fact constrained, e.g.&nbsp;we were working with a <code>Beta</code> distribution which has support on the interval <span class="math inline">\((0, 1)\)</span>, <em>not</em> on <span class="math inline">\(\mathbb{R}^d\)</span>, we could easily end up outside of the valid range <span class="math inline">\((0, 1)\)</span>.</p>
<div id="44" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="fu">beta_model</span>() <span class="op">=</span> x <span class="op">~</span> <span class="fu">Beta</span>(<span class="fl">3</span>, <span class="fl">3</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>turing_model <span class="op">=</span> <span class="fu">beta_model</span>()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×2×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 1.84 seconds
Compute duration  = 1.84 seconds
parameters        = x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold">  ess_bulk </span> <span class="ansi-bold">  ess_tail </span> <span class="ansi-bold">    rhat </span>  ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>  ⋯

           x    0.5019    0.1902    0.0030   3971.9427   5372.5951    1.0002   ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

           x    0.1503    0.3599    0.5013    0.6414    0.8564
</pre>
</div>
</div>
</div>
<p>Yep, that still works, but only because Turing.jl actually <em>transforms</em> the <code>turing_model</code> from constrained to unconstrained, so that the <code>sampler</code> provided to <code>externalsampler</code> is actually always working in unconstrained space! This is not always desirable, so we can turn this off:</p>
<div id="46" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">false</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×2×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 0.25 seconds
Compute duration  = 0.25 seconds
parameters        = x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

           x    0.5253    0.1516    0.0165    70.8237        NaN    1.0164     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

           x    0.2493    0.4086    0.5276    0.6535    0.7786
</pre>
</div>
</div>
</div>
<p>The fun thing is that this still sort of works because</p>
<div id="48" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logpdf</span>(<span class="fu">Beta</span>(<span class="fl">3</span>, <span class="fl">3</span>), <span class="fl">10.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-Inf</code></pre>
</div>
</div>
<p>and so the samples that fall outside of the range are always rejected. But do notice how much worse all the diagnostics are, e.g.&nbsp;<code>ess_tail</code> is very poor compared to when we use <code>unconstrained=true</code>. Moreover, in more complex cases this won’t just result in a “nice” <code>-Inf</code> log-density value, but instead will error:</p>
<div id="50" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">demo</span>()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    σ² <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Normal</span>(), lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we end up with negative values for `σ²`, the `Normal` will error.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, σ²)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">demo</span>(), <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">false</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre>DomainError with -0.09126345931628499:
Normal: the condition σ &gt;= zero(σ) is not satisfied.
Stacktrace:
  [1] <span class="ansi-bold">#371</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [2] <span class="ansi-bold">check_args</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">utils.jl:89</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [3] <span class="ansi-bold">#Normal#370</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [4] <span class="ansi-bold">Normal</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:36</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [5] <span class="ansi-bold">Normal</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:42</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [6] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">compiler.jl:579</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [7] <span class="ansi-bold">demo</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">__model__</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">__varinfo__</span>::DynamicPPL.ThreadSafeVarInfo<span class="ansi-bright-black-fg">{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, Vector{Base.RefValue{Float64}}}</span>, <span class="ansi-bright-black-fg">__context__</span>::DynamicPPL.ValuesAsInModelContext<span class="ansi-bright-black-fg">{OrderedDict{Any, Any}, DynamicPPL.DefaultContext}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">Main.Notebook</span> <span class="ansi-bright-black-fg">~/work/turing-docs/turing-docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:454</span>
  [8] <span class="ansi-bold">_evaluate!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:963</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [9] <span class="ansi-bold">evaluate_threadsafe!!</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">varinfo</span>::DynamicPPL.TypedVarInfo<span class="ansi-bright-black-fg">{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}</span>, <span class="ansi-bright-black-fg">context</span>::DynamicPPL.ValuesAsInModelContext<span class="ansi-bright-black-fg">{OrderedDict{Any, Any}, DynamicPPL.DefaultContext}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-cyan-fg">DynamicPPL</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:952</span>
 [10] <span class="ansi-bold">evaluate!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:887</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [11] <span class="ansi-bold">values_as_in_model</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">values_as_in_model.jl:196</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [12] <span class="ansi-bold">values_as_in_model</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">values_as_in_model.jl:195</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [13] <span class="ansi-bold">getparams</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">vi</span>::DynamicPPL.TypedVarInfo<span class="ansi-bright-black-fg">{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-green-fg">Turing.Inference</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:328</span>
 [14] <span class="ansi-bold">Turing.Inference.Transition</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">vi</span>::DynamicPPL.TypedVarInfo<span class="ansi-bright-black-fg">{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}</span>, <span class="ansi-bright-black-fg">t</span>::MALASample<span class="ansi-bright-black-fg">{Vector{Float64}}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-green-fg">Turing.Inference</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:224</span>
 [15] <span class="ansi-bold">transition_to_turing</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:12</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [16] <span class="ansi-bold">transition_to_turing</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">f</span>::LogDensityProblemsADForwardDiffExt.ForwardDiffLogDensity<span class="ansi-bright-black-fg">{LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}, ForwardDiff.Chunk{2}, ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, ForwardDiff.GradientConfig{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}}</span>, <span class="ansi-bright-black-fg">transition</span>::MALASample<span class="ansi-bright-black-fg">{Vector{Float64}}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-green-fg">Turing.Inference</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:17</span>
 [17] <span class="ansi-bold">step</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler_wrapper</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>; <span class="ansi-bright-black-fg">initial_state</span>::Nothing, <span class="ansi-bright-black-fg">initial_params</span>::Nothing, <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-green-fg">Turing.Inference</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:76</span>
 [18] <span class="ansi-bold">step</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:36</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [19] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sample.jl:130</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [20] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">logging.jl:16</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [21] <span class="ansi-bold">mcmcsample</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">N</span>::Int64; <span class="ansi-bright-black-fg">progress</span>::Bool, <span class="ansi-bright-black-fg">progressname</span>::String, <span class="ansi-bright-black-fg">callback</span>::Nothing, <span class="ansi-bright-black-fg">discard_initial</span>::Int64, <span class="ansi-bright-black-fg">thinning</span>::Int64, <span class="ansi-bright-black-fg">chain_type</span>::Type, <span class="ansi-bright-black-fg">initial_state</span>::Nothing, <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-yellow-fg">AbstractMCMC</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sample.jl:120</span>
 [22] <span class="ansi-bold">sample</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">N</span>::Int64; <span class="ansi-bright-black-fg">chain_type</span>::Type, <span class="ansi-bright-black-fg">resume_from</span>::Nothing, <span class="ansi-bright-black-fg">initial_state</span>::Nothing, <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{progress::Bool}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-cyan-fg">DynamicPPL</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sampler.jl:93</span>
 [23] <span class="ansi-bold">sample</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sampler.jl:83</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [24] <span class="ansi-bold">#sample#4</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:263</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [25] <span class="ansi-bold">sample</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:256</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [26] <span class="ansi-bold">#sample#3</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:253</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [27] top-level scope
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/work/turing-docs/turing-docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:456</span></pre>
</div>
</div>
</div>
<p>As expected, we run into a <code>DomainError</code> at some point, while if we set <code>unconstrained=true</code>, letting Turing.jl transform the model to a unconstrained form behind the scenes, everything works as expected:</p>
<div id="52" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">demo</span>(), <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">true</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×3×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 1.67 seconds
Compute duration  = 1.67 seconds
parameters        = σ², x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

          σ²    0.8693    0.5917    0.0324   248.5176   127.4979    1.0019     ⋯
           x    0.0282    0.9825    0.0539   375.0683   423.8060    1.0070     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

          σ²    0.0971    0.3822    0.7486    1.2266    2.2655
           x   -1.9053   -0.4375   -0.0202    0.4462    2.4520
</pre>
</div>
</div>
</div>
<p>Neat!</p>
<p>Similarly, which automatic differentiation backend one should use can be specified through the <code>adtype</code> keyword argument too. For example, if we want to use <a href="https://github.com/JuliaDiff/ReverseDiff.jl">ReverseDiff.jl</a> instead of the default <a href="https://github.com/JuliaDiff/ForwardDiff.jl">ForwardDiff.jl</a>:</p>
<div id="54" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ReverseDiff</span>: ReverseDiff</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify that we want to use `AutoReverseDiff`.</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">demo</span>(),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">true</span>, adtype<span class="op">=</span><span class="fu">AutoReverseDiff</span>()),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="fl">10_000</span>;</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">=</span><span class="cn">false</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×3×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 3.17 seconds
Compute duration  = 3.17 seconds
parameters        = σ², x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

          σ²    0.8418    0.5872    0.0407   166.9672    53.5617    1.0085     ⋯
           x    0.1392    1.1609    0.1388   161.2651    59.1801    1.0018     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

          σ²    0.1575    0.3746    0.7083    1.1851    2.2709
           x   -1.9279   -0.3310   -0.0020    0.4276    3.6985
</pre>
</div>
</div>
</div>
<p>Double-neat.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>At this point it’s worth maybe reminding ourselves what we did and also <em>why</em> we did it:</p>
<ol type="1">
<li>We define our models in the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface because it makes the sampler agnostic to how the underlying model is implemented.</li>
<li>We implement our sampler in the <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> interface, which just means that our sampler is a subtype of <code>AbstractMCMC.AbstractSampler</code> and we implement the MCMC transition in <code>AbstractMCMC.step</code>.</li>
<li>Points 1 and 2 makes it so our sampler can be used with a wide range of model implementations, amongst them being models implemented in both Turing.jl and Stan. This gives you, the inference implementer, a large collection of models to test your inference method on, in addition to allowing users of Turing.jl and Stan to try out your inference method with minimal effort.</li>
</ol>


</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>We’re going with the leapfrog formulation because in a future version of this tutorial we’ll add a section extending this simple “baseline” MALA sampler to more complex versions. See <a href="https://github.com/TuringLang/docs/issues/479">issue #479</a> for progress on this.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>There is no such thing as a proper interface in Julia (at least not officially), and so we use the word “interface” here to mean a few minimal methods that needs to be implemented by any type that we treat as a target model.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/turinglang\.org\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../tutorials/docs-07-for-developers-variational-inference/index.html" class="pagination-link" aria-label="Variational Inference">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Variational Inference</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../versions.html" class="pagination-link" aria-label="Versions">
        <span class="nav-page-text">Versions</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Turing is created by <a href="http://mlg.eng.cam.ac.uk/hong/" target="_blank">Hong Ge</a>, and lovingly maintained by the <a href="https://github.com/TuringLang/Turing.jl/graphs/contributors" target="_blank">core team</a> of volunteers. <br> The contents of this website are © 2024 under the terms of the <a href="https://github.com/TuringLang/Turing.jl/blob/master/LICENCE" target="_blank">MIT License</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-17-implementing-samplers/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/TuringLang">
      <i class="bi bi-twitter" role="img" aria-label="Turing Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/TuringLang/Turing.jl">
      <i class="bi bi-github" role="img" aria-label="Turing GitHub">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>